<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>你畫我猜成語版</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@500;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="questions.js"></script>

    <style>
        :root {
            --main-bg: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            --box-bg: #ffffff;
            --box-shadow: 0 10px 30px rgba(0,0,0,0.25);
            
            --text-main: #2c3e50;
            --text-sub: #636e72;
            
            --accent-color: #ff6b6b; /* 珊瑚紅 */
            --secondary-color: #48dbfb; /* 天藍 */
            --secondary-dark: #0abde3;
            --gold: #feca57; /* 金色 icon 用 */
            
            --danger: #ff4757;
        }

        * { box-sizing: border-box; user-select: none; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: 'Noto Sans TC', sans-serif;
            background: var(--main-bg);
            color: var(--text-main);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            min-height: 100vh; margin: 0; padding: 15px; overflow-x: hidden;
        }

        .variety-box {
            background: var(--box-bg); 
            border-radius: 24px;
            box-shadow: var(--box-shadow);
            padding: 30px 25px; 
            position: relative;
            margin-bottom: 20px;
            width: 100%; max-width: 600px;
            text-align: center; 
            border: 1px solid rgba(255,255,255,0.1);
        }

        /* 標題區域優化 */
        h1 {
            color: var(--text-main); 
            font-weight: 900; 
            font-size: 2.2rem; 
            margin: 10px 0 25px 0;
            letter-spacing: 1px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px; /* 圖示與文字的距離 */
        }
        
        /* 標題圖示顏色 */
        h1 i { color: var(--accent-color); font-size: 1.8rem; }

        /* 右上角規則按鈕 */
        #guide-btn-integrated {
            position: absolute;
            top: 20px; right: 20px;
            background: #f1f2f6;
            color: #747d8c;
            border: none; border-radius: 50%;
            width: 40px; height: 40px;
            font-size: 1.2rem;
            cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            transition: all 0.2s;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        #guide-btn-integrated:hover {
            background: var(--secondary-dark); color: #fff; transform: rotate(15deg);
        }

        .setting-group { margin-bottom: 20px; text-align: left; padding: 0 10px; }
        
        /* 標籤加上圖示 */
        .setting-group label {
            display: flex; align-items: center; gap: 8px;
            color: var(--text-main);
            font-weight: 700; font-size: 1.1rem; margin-bottom: 8px;
        }
        .setting-group label i { color: var(--secondary-dark); width: 20px; text-align: center; }

        .remain-hint { font-size: 0.85rem; color: var(--text-sub); margin-top: 5px; font-weight: 500; margin-left: 30px; }

        input[type="number"] { 
            width: 100%; border: 2px solid #dfe4ea; border-radius: 12px; padding: 12px; 
            font-size: 1.4rem; font-weight: 700; text-align: center; color: #2f3542; background: #f1f2f6; transition: border-color 0.2s;
        }
        input[type="number"]:focus { border-color: var(--secondary-dark); outline: none; background: #fff; }

        .btn {
            background: var(--accent-color); color: #fff; border: none; border-radius: 50px; 
            padding: 16px 30px; font-size: 1.4rem; font-weight: 700; 
            cursor: pointer; width: 100%; margin-top: 20px;
            box-shadow: 0 4px 15px rgba(255, 107, 107, 0.4); transition: all 0.2s;
            display: flex; align-items: center; justify-content: center; gap: 10px; /* 圖示文字間距 */
        }
        .btn:active { transform: scale(0.98); box-shadow: 0 2px 5px rgba(255, 107, 107, 0.2); }
        .btn:disabled { background: #ced6e0; box-shadow: none; cursor: not-allowed; }

        .btn-blue { background: var(--secondary-dark); box-shadow: 0 4px 15px rgba(10, 189, 227, 0.4); }
        .btn-blue:active { box-shadow: 0 2px 5px rgba(10, 189, 227, 0.2); }

        .btn-quit {
            background: transparent; color: #a4b0be; border: none; box-shadow: none;
            font-size: 0.9rem; padding: 15px; margin-top: 10px; text-decoration: none; width: auto;
            cursor: pointer; transition: color 0.3s;
            display: inline-flex; align-items: center; gap: 5px;
        }
        .btn-quit:hover { color: var(--danger); text-decoration: underline; }

        #game-screen { display: none; }

        .status-bar {
            display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; 
            font-size: 1rem; font-weight: 700; color: #57606f; 
            background: #f1f2f6; padding: 10px 20px; border-radius: 50px;
        }
        .status-bar i { margin-right: 5px; }

        #question-display {
            font-size: 4rem; font-weight: 900; min-height: 220px;
            display: flex; align-items: center; justify-content: center;
            color: #2f3542; background: #fff; border: 2px dashed #dfe4ea;
            border-radius: 20px; margin: 15px 0; padding: 10px; word-break: keep-all;
        }

        .timer-box { 
            font-size: 2.5rem; font-weight: 700; margin: 10px auto; padding: 5px 30px; 
            color: var(--secondary-dark); display: inline-flex; align-items: center; gap: 10px;
            font-feature-settings: "tnum";
        }
        .timer-warning { color: var(--danger); animation: pulse 0.5s infinite alternate; }
        @keyframes pulse { from { opacity: 1; } to { opacity: 0.6; } }

        .switch-container { display: inline-flex; align-items: center; justify-content: center; margin-top: 15px; font-size: 0.9rem; font-weight: 500; color: #a4b0be; cursor: pointer; gap: 8px; }
        .toggle-box { width: 40px; height: 22px; background: #dfe4ea; border-radius: 20px; position: relative; transition: background 0.3s; }
        .toggle-circle { width: 16px; height: 16px; background: #fff; border-radius: 50%; position: absolute; top: 3px; left: 3px; transition: transform 0.3s; box-shadow: 0 1px 3px rgba(0,0,0,0.2); }
        .active .toggle-box { background: var(--secondary-dark); }
        .active .toggle-circle { transform: translateX(18px); }

        .reload-link { margin-top: 25px; font-size: 0.9rem; color: #ccc; cursor:pointer; font-weight: 500; transition: color 0.3s; display: inline-flex; align-items: center; gap: 5px; }
        .reload-link:hover { color: var(--danger); }

        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); backdrop-filter: blur(2px); z-index: 2000; display: none; align-items: center; justify-content: center; padding: 20px; }
        .modal-box { background: #fff; border-radius: 24px; padding: 30px; width: 100%; max-width: 450px; max-height: 85vh; overflow-y: auto; box-shadow: 0 20px 50px rgba(0,0,0,0.3); }
        .modal-title { color: #2c3e50; text-align: center; font-size: 1.5rem; font-weight: 700; margin-bottom: 20px; border-bottom: 1px solid #eee; padding-bottom: 15px; display: flex; align-items: center; justify-content: center; gap: 10px;}
        .guide-section { margin-bottom: 18px; line-height: 1.6; font-size: 1rem; color: #555; text-align: left;}
        .guide-section strong { color: var(--accent-color); }

        @media (max-width: 600px) {
            .variety-box { padding: 25px 20px; }
            h1 { font-size: 1.8rem; }
            #question-display { min-height: 180px; font-size: 3rem; } 
            .btn { font-size: 1.3rem; padding: 14px; }
        }
    </style>
</head>
<body>

    <audio id="bgm-player" loop><source src="bg-music.mp3" type="audio/mpeg"></audio>

    <div id="guide-modal" class="modal-overlay" onclick="closeGuide(event)">
        <div class="modal-box" onclick="event.stopPropagation()">
            <div class="modal-title"><i class="fas fa-book-open"></i> 遊戲規則</div>
            <div class="guide-section"><strong><i class="fas fa-shapes"></i> 1. 基礎與進階</strong><br>「基礎題」多為具象好畫的成語；「進階題」則為抽象或複雜的挑戰。</div>
            <div class="guide-section"><strong><i class="fas fa-brain"></i> 2. 智慧不重複</strong><br>系統會記住這台裝置玩過的題目，直到題庫用盡。</div>
            <div class="guide-section"><strong><i class="fas fa-stopwatch"></i> 3. 操作密技</strong><br>時間設定可按上下鍵增減 10 秒。遊戲中可按「放棄」回到首頁。</div>
            <div class="guide-section"><strong><i class="fas fa-trash-alt"></i> 4. 重置紀錄</strong><br>若想重新遊玩所有題目，請點擊設定頁下方的「清除紀錄」。</div>
            <button class="btn" onclick="closeGuide(null)" style="margin-top:10px;">
                <i class="fas fa-check"></i> 我知道了
            </button>
        </div>
    </div>

    <div id="setup-screen" class="variety-box">
        <button id="guide-btn-integrated" onclick="openGuide()" title="規則說明">
            <i class="fas fa-question"></i>
        </button>

        <h1>
            <i class="fas fa-palette"></i> 
            你畫我猜 
            <span style="font-size:1.1rem; color:#888; font-weight:500; margin-top:8px;">成語版</span>
        </h1>
        
        <div class="setting-group">
            <label><i class="fas fa-cubes"></i> 基礎題數 (具象)</label>
            <input type="number" id="basic-count" value="3" min="0">
            <span id="basic-remain" class="remain-hint">載入中...</span>
        </div>

        <div class="setting-group">
            <label><i class="fas fa-layer-group"></i> 進階題數 (抽象)</label>
            <input type="number" id="adv-count" value="2" min="0">
            <span id="adv-remain" class="remain-hint">載入中...</span>
        </div>

        <div class="setting-group">
            <label><i class="fas fa-hourglass-half"></i> 倒數時間 (秒)</label>
            <input type="number" id="timer-set" value="20" min="10" step="10">
        </div>

        <div class="switch-container" onclick="toggleBGMSetup()" id="setup-bgm-switch">
            <div class="toggle-box"><div class="toggle-circle"></div></div>
            <span><i class="fas fa-music"></i> 背景音樂 (BGM)</span>
        </div>

        <button class="btn" onclick="startGame()">
            <i class="fas fa-play"></i> 開始挑戰
        </button>
        
        <div class="reload-link" onclick="resetHistory()">
            <i class="fas fa-trash-alt"></i> 清除已玩紀錄 (重置題庫)
        </div>
    </div>

    <div id="game-screen" class="variety-box">
        <div class="status-bar">
            <span id="level-tag" style="color:var(--secondary-dark);">
                <i class="fas fa-tag"></i> 基礎題
            </span>
            <span id="progress-text">1 / 5</span>
        </div>

        <div id="question-display">準備中...</div>
        
        <div class="timer-box" id="timer-display">
            <i class="fas fa-clock"></i> --
        </div>

        <button class="btn btn-blue" id="timer-btn" onclick="toggleTimer()">
            <i class="fas fa-stopwatch"></i> 開始計時
        </button>
        
        <button class="btn" id="next-btn" onclick="nextQuestion()">
            下一題 <i class="fas fa-chevron-right"></i>
        </button>
        
        <div style="margin-top: 15px;">
            <div class="switch-container" onclick="toggleBGMGame()" id="game-bgm-switch">
                <div class="toggle-box"><div class="toggle-circle"></div></div>
                <span><i class="fas fa-music"></i> BGM</span>
            </div>
        </div>

        <button class="btn-quit" onclick="confirmQuit()">
            <i class="fas fa-undo"></i> 放棄本局 / 回到設定
        </button>
    </div>

    <script>
        // --- 遊戲狀態 ---
        let gameQueue = [];
        let currentIndex = -1;
        let timerDuration = 60;
        let timerInterval = null;
        let isBGMOn = false;
        let audioContext = null;
        let playedHistory = JSON.parse(localStorage.getItem('playedIdiomsHistory')) || [];

        // --- DOM ---
        const setupScreen = document.getElementById('setup-screen');
        const gameScreen = document.getElementById('game-screen');
        const bgmPlayer = document.getElementById('bgm-player');
        const questionDisplay = document.getElementById('question-display');
        const progressText = document.getElementById('progress-text');
        const levelTag = document.getElementById('level-tag');
        const timerDisplay = document.getElementById('timer-display');
        const timerBtn = document.getElementById('timer-btn');
        const nextBtn = document.getElementById('next-btn');
        const guideModal = document.getElementById('guide-modal');
        const basicRemainLabel = document.getElementById('basic-remain');
        const advRemainLabel = document.getElementById('adv-remain');

        // --- 檢查題庫 ---
        if (typeof db_basic === 'undefined' || typeof db_advanced === 'undefined') {
            alert("⚠️ 錯誤：找不到題庫檔案 questions.js！\n請確認 index.html 與 questions.js 放在同一個資料夾內。");
        }

        function updateRemainCounts() {
            if (typeof db_basic === 'undefined') return;
            const availableBasic = db_basic.filter(q => !playedHistory.includes(q));
            const availableAdv = db_advanced.filter(q => !playedHistory.includes(q));
            basicRemainLabel.innerText = `(尚有 ${availableBasic.length} 題未玩過)`;
            advRemainLabel.innerText = `(尚有 ${availableAdv.length} 題未玩過)`;
        }
        updateRemainCounts();

        function openGuide() { guideModal.style.display = 'flex'; }
        function closeGuide(event) { if (event === null || event.target === guideModal) guideModal.style.display = 'none'; }

        // --- 1. 開始遊戲 ---
        function startGame() {
            const basicCount = parseInt(document.getElementById('basic-count').value) || 0;
            const advCount = parseInt(document.getElementById('adv-count').value) || 0;
            timerDuration = parseInt(document.getElementById('timer-set').value) || 20;

            if (basicCount + advCount === 0) { alert("請至少設定一題！"); return; }

            const availableBasic = db_basic.filter(q => !playedHistory.includes(q));
            const availableAdv = db_advanced.filter(q => !playedHistory.includes(q));

            if (basicCount > availableBasic.length || advCount > availableAdv.length) {
                alert(`題庫存量不足！\n\n基礎題剩: ${availableBasic.length}\n進階題剩: ${availableAdv.length}\n\n請減少設定數量。`);
                return;
            }

            const finalBasic = shuffleArray([...availableBasic]).slice(0, basicCount).map(t => ({text: t, type: '基礎題', color: 'var(--secondary-dark)'}));
            const finalAdv = shuffleArray([...availableAdv]).slice(0, advCount).map(t => ({text: t, type: '進階題', color: 'var(--accent-color)'}));
            
            gameQueue = [...finalBasic, ...finalAdv];

            if (!audioContext) audioContext = new (window.AudioContext || window.webkitAudioContext)();
            setupScreen.style.display = 'none';
            gameScreen.style.display = 'block';
            if (isBGMOn) { bgmPlayer.volume = 0.5; bgmPlayer.play().catch(e => console.log("BGM Blocked")); }

            nextQuestion();
        }

        // --- 2. 題目控制 ---
        function nextQuestion() {
            stopTimer();
            // 重置計時器顯示
            timerDisplay.innerHTML = '<i class="fas fa-clock"></i> ' + timerDuration;
            timerDisplay.classList.remove('timer-warning');
            
            timerBtn.innerHTML = '<i class="fas fa-stopwatch"></i> 開始計時';
            timerBtn.disabled = false;
            timerBtn.classList.add('btn-blue');
            timerBtn.style.background = ""; // 清除可能殘留的樣式

            currentIndex++;

            if (currentIndex >= gameQueue.length) {
                questionDisplay.innerHTML = "<span style='font-size: 2.5rem; color:var(--accent-color);'><i class='fas fa-flag-checkered'></i> 挑戰結束！</span>";
                progressText.innerText = "END"; levelTag.innerHTML = "";
                nextBtn.innerHTML = "<i class='fas fa-redo'></i> 新的一局";
                nextBtn.onclick = () => location.reload();
                timerBtn.disabled = true;
                timerBtn.classList.remove('btn-blue');
                timerBtn.style.background = "#ccc";
                return;
            }

            const q = gameQueue[currentIndex];
            questionDisplay.innerText = q.text;

            playedHistory.push(q.text);
            localStorage.setItem('playedIdiomsHistory', JSON.stringify(playedHistory));
            
            const isMobile = window.innerWidth < 600;
            if (q.text.length > 5) {
                questionDisplay.style.fontSize = isMobile ? "2.5rem" : "3.5rem";
            } else {
                questionDisplay.style.fontSize = isMobile ? "3.5rem" : "5rem";
            }

            progressText.innerText = `${currentIndex + 1} / ${gameQueue.length}`;
            levelTag.innerHTML = `<i class="fas fa-tag"></i> ${q.type}`;
            levelTag.style.color = q.color;
        }

        // --- 3. 計時器與音效 ---
        function toggleTimer() {
            if (timerInterval) { stopTimer(); return; }
            let timeLeft = timerDuration;
            timerDisplay.innerHTML = '<i class="fas fa-clock"></i> ' + timeLeft;
            
            timerBtn.innerHTML = '<i class="fas fa-pause"></i> 停止';
            timerBtn.classList.remove('btn-blue'); 
            timerBtn.style.background = "#57606f";
            
            timerInterval = setInterval(() => {
                timeLeft--;
                timerDisplay.innerHTML = '<i class="fas fa-clock"></i> ' + timeLeft;

                if (timeLeft <= 5 && timeLeft > 0) {
                    timerDisplay.classList.add('timer-warning');
                    let pitch = 880 + (5 - timeLeft) * 50; 
                    playBeep(pitch, 0.15, 'square', 0.5); 
                } else if (timeLeft === 0) {
                    playBeep(200, 1.5, 'sawtooth', 1.0); 
                    timerDisplay.innerHTML = '<i class="fas fa-times-circle"></i> 時間到';
                    stopTimer();
                    timerBtn.innerHTML = '<i class="fas fa-stopwatch"></i> 開始計時';
                    timerBtn.disabled = true;
                    timerBtn.style.background = "#ccc";
                }
            }, 1000);
        }

        function stopTimer() { 
            clearInterval(timerInterval); 
            timerInterval = null; 
            timerDisplay.classList.remove('timer-warning'); 
            if(!timerBtn.disabled) {
                timerBtn.innerHTML = '<i class="fas fa-stopwatch"></i> 開始計時';
                timerBtn.classList.add('btn-blue');
                timerBtn.style.background = ""; 
            }
        }

        function playBeep(frequency, duration, type = 'sine', volume = 1.0) {
            if (!audioContext) return;
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            oscillator.type = type;
            oscillator.frequency.value = frequency;
            gainNode.gain.setValueAtTime(volume, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + duration);
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            oscillator.start();
            oscillator.stop(audioContext.currentTime + duration);
        }

        function toggleBGMSetup() { isBGMOn = !isBGMOn; updateSwitchUI('setup-bgm-switch', isBGMOn); updateSwitchUI('game-bgm-switch', isBGMOn); }
        function toggleBGMGame() { isBGMOn = !isBGMOn; updateSwitchUI('setup-bgm-switch', isBGMOn); updateSwitchUI('game-bgm-switch', isBGMOn); if (isBGMOn) bgmPlayer.play(); else bgmPlayer.pause(); }
        function updateSwitchUI(id, isOn) { 
            const box = document.getElementById(id);
            if (isOn) box.classList.add('active'); else box.classList.remove('active'); 
        }
        function shuffleArray(array) { for (let i = array.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [array[i], array[j]] = [array[j], array[i]]; } return array; }

        function resetHistory() {
            if (confirm("【確認】\n確定要清除紀錄嗎？\n清除後，成語將會重新重複出現。")) {
                localStorage.removeItem('playedIdiomsHistory');
                alert("紀錄已清除！");
                location.reload();
            }
        }

        function confirmQuit() {
            if (confirm("遊戲正在進行中，確定要放棄並回到設定頁嗎？")) {
                location.reload();
            }
        }
    </script>
</body>
</html>