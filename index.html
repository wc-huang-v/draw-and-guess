<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ä½ ç•«æˆ‘çŒœæˆèªç‰ˆ</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@500;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="questions.js"></script>

    <style>
        :root {
            --main-bg: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            --box-bg: #ffffff;
            --box-shadow: 0 10px 30px rgba(0,0,0,0.25);
            --text-main: #2c3e50;
            --text-sub: #636e72;
            --accent-color: #ff6b6b;
            --secondary-color: #48dbfb;
            --secondary-dark: #0abde3;
            --danger: #ff4757;
            --demo-color: #f1c40f; 
            
            /* BGM é–‹å•Ÿæ™‚çš„é¡è‰² (äº®è—è‰²) */
            --switch-on-color: #007bff; 
        }

        * { box-sizing: border-box; user-select: none; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: 'Noto Sans TC', sans-serif;
            background: var(--main-bg);
            color: var(--text-main);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            min-height: 100vh; margin: 0; padding: 15px; overflow-x: hidden;
        }

        .variety-box {
            background: var(--box-bg); 
            border-radius: 24px;
            box-shadow: var(--box-shadow);
            padding: 30px 25px; 
            position: relative;
            margin-bottom: 20px;
            width: 100%; max-width: 600px;
            text-align: center; 
            border: 1px solid rgba(255,255,255,0.1);
            overflow: hidden; 
        }

        /* --- æ¨™é¡Œæ¨£å¼ --- */
        h1 {
            color: var(--text-main); font-weight: 900; font-size: 2.2rem; 
            margin: 10px 0 25px 0; letter-spacing: 1px;
            display: flex; align-items: center; justify-content: center; gap: 15px;
        }
        h1 i { color: var(--accent-color); font-size: 1.8rem; }

        /* --- å³ä¸Šè§’æŒ‰éˆ•ç¾¤çµ„ (é›»è…¦ç‰ˆ) --- */
        .top-btn-group {
            position: absolute; top: 20px; right: 20px;
            display: flex; gap: 10px; z-index: 100;
        }

        .circle-btn {
            background: #f1f2f6; color: #747d8c;
            border: none; border-radius: 50%;
            width: 40px; height: 40px;
            font-size: 1.2rem; cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            transition: all 0.2s;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .circle-btn:hover { background: var(--secondary-dark); color: #fff; transform: scale(1.1); }
        
        #demo-btn { color: #f39c12; }
        #demo-btn:hover { background: #f39c12; color: #fff; }

        .demo-ribbon {
            position: absolute; top: 25px; left: -30px; width: 120px;
            background: var(--demo-color); color: #333; font-weight: 900;
            font-size: 0.8rem; text-align: center; line-height: 25px;
            transform: rotate(-45deg); box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            z-index: 10; display: none; pointer-events: none; 
        }

        .setting-group { margin-bottom: 20px; text-align: left; padding: 0 10px; }
        .setting-group label { display: flex; align-items: center; gap: 8px; color: var(--text-main); font-weight: 700; font-size: 1.1rem; margin-bottom: 8px; }
        .setting-group label i { color: var(--secondary-dark); width: 20px; text-align: center; }
        .remain-hint { font-size: 0.85rem; color: var(--text-sub); margin-top: 5px; font-weight: 500; margin-left: 30px; }

        input[type="number"] { width: 100%; border: 2px solid #dfe4ea; border-radius: 12px; padding: 12px; font-size: 1.4rem; font-weight: 700; text-align: center; color: #2f3542; background: #f1f2f6; transition: border-color 0.2s; }
        input[type="number"]:focus { border-color: var(--secondary-dark); outline: none; background: #fff; }

        .btn {
            background: var(--accent-color); color: #fff; border: none; border-radius: 50px; 
            padding: 16px 30px; font-size: 1.4rem; font-weight: 700; cursor: pointer; width: 100%; margin-top: 20px;
            box-shadow: 0 4px 15px rgba(255, 107, 107, 0.4); transition: all 0.2s;
            display: flex; align-items: center; justify-content: center; gap: 10px;
        }
        .btn:active { transform: scale(0.98); box-shadow: 0 2px 5px rgba(255, 107, 107, 0.2); }
        .btn:disabled { background: #ced6e0; box-shadow: none; cursor: not-allowed; }

        .btn-blue { background: var(--secondary-dark); box-shadow: 0 4px 15px rgba(10, 189, 227, 0.4); }
        .btn-blue:active { box-shadow: 0 2px 5px rgba(10, 189, 227, 0.2); }

        .btn-quit {
            background: transparent; color: #a4b0be; border: none; box-shadow: none;
            font-size: 0.9rem; padding: 15px; margin-top: 10px; text-decoration: none; width: auto;
            cursor: pointer; transition: color 0.3s; display: inline-flex; align-items: center; gap: 5px;
        }
        .btn-quit:hover { color: var(--danger); text-decoration: underline; }

        #game-screen { display: none; }
        .status-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; font-size: 1rem; font-weight: 700; color: #57606f; background: #f1f2f6; padding: 10px 20px; border-radius: 50px; }
        .status-bar i { margin-right: 5px; }

        #question-display {
            font-size: 4rem; font-weight: 900; min-height: 220px;
            display: flex; align-items: center; justify-content: center;
            color: #2f3542; background: #fff; border: 2px dashed #dfe4ea;
            border-radius: 20px; margin: 15px 0; padding: 10px; word-break: keep-all;
        }

        .timer-box { font-size: 2.5rem; font-weight: 700; margin: 10px auto; padding: 5px 30px; color: var(--secondary-dark); display: inline-flex; align-items: center; gap: 10px; font-feature-settings: "tnum"; }
        .timer-warning { color: var(--danger); animation: pulse 0.5s infinite alternate; }
        @keyframes pulse { from { opacity: 1; } to { opacity: 0.6; } }

        /* --- BGM Switch æ¨£å¼ (ä¿®æ­£ç‰ˆ) --- */
        .switch-container { display: inline-flex; align-items: center; justify-content: center; margin-top: 15px; font-size: 0.9rem; font-weight: 500; color: #a4b0be; cursor: pointer; gap: 8px; }
        
        .toggle-box { 
            width: 40px; height: 22px; 
            background: #dfe4ea; /* OFF é è¨­ç°è‰² */
            border-radius: 20px; position: relative; transition: background 0.3s; 
        }
        .toggle-circle { 
            width: 16px; height: 16px; 
            background: #fff; border-radius: 50%; 
            position: absolute; top: 3px; left: 3px; 
            transition: transform 0.3s; box-shadow: 0 1px 3px rgba(0,0,0,0.2); 
        }
        
        /* â˜… ON ç‹€æ…‹ï¼šçˆ¶å±¤æœ‰ active æ™‚ï¼Œå…§éƒ¨ toggle-box è®Šè—è‰² */
        .switch-container.active .toggle-box { 
            background: var(--switch-on-color); 
        }
        /* â˜… ON ç‹€æ…‹ï¼šåœ“é»ä½ç§» */
        .switch-container.active .toggle-circle { 
            transform: translateX(18px); 
        }

        .reload-link { margin-top: 25px; font-size: 0.9rem; color: #ccc; cursor:pointer; font-weight: 500; transition: color 0.3s; display: inline-flex; align-items: center; gap: 5px; }
        .reload-link:hover { color: var(--danger); }

        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); backdrop-filter: blur(2px); z-index: 2000; display: none; align-items: center; justify-content: center; padding: 20px; }
        .modal-box { background: #fff; border-radius: 24px; padding: 30px; width: 100%; max-width: 450px; max-height: 85vh; overflow-y: auto; box-shadow: 0 20px 50px rgba(0,0,0,0.3); }
        .modal-title { color: #2c3e50; text-align: center; font-size: 1.5rem; font-weight: 700; margin-bottom: 20px; border-bottom: 1px solid #eee; padding-bottom: 15px; display: flex; align-items: center; justify-content: center; gap: 10px;}
        .guide-section { margin-bottom: 18px; line-height: 1.6; font-size: 1rem; color: #555; text-align: left;}
        .guide-section strong { color: var(--accent-color); }

        /* --- â˜… RWD æ‰‹æ©Ÿç‰ˆå„ªåŒ–ï¼šæŒ‰éˆ•é˜²æ“‹ + æ¨™é¡Œé¿è®“ --- */
        @media (max-width: 600px) {
            .variety-box { 
                padding: 25px 20px; 
                padding-top: 60px; /* å¢åŠ é ‚éƒ¨ç•™ç™½ï¼Œçµ¦æŒ‰éˆ•ç¾¤çµ„ç”¨ */
            }
            
            /* æ‰‹æ©Ÿç‰ˆï¼šæŒ‰éˆ•ç¾¤çµ„ä¸å†çµ•å°å®šä½ï¼Œæ”¹ç‚ºç›¸å°å®šä½ä¸¦ç½®é ‚ï¼Œç¢ºä¿ä¸é‡ç–Š */
            .top-btn-group {
                position: absolute;
                top: 15px;
                right: 15px;
                width: auto;
            }
            
            /* æ¨™é¡Œä¸éœ€é¡å¤– marginï¼Œå› ç‚ºå®¹å™¨ padding å·²ç¶“æ’é–‹ */
            h1 { 
                font-size: 1.8rem; 
                margin-top: 0;
            }
            
            #question-display { min-height: 180px; font-size: 3rem; } 
            .btn { font-size: 1.3rem; padding: 14px; }
        }
    </style>
</head>
<body>

    <audio id="bgm-player" loop><source src="bg-music.mp3" type="audio/mpeg"></audio>

    <div id="guide-modal" class="modal-overlay" onclick="closeGuide(event)">
        <div class="modal-box" onclick="event.stopPropagation()">
            <div class="modal-title"><i class="fas fa-book-open"></i> éŠæˆ²è¦å‰‡</div>
            <div class="guide-section"><strong><i class="fas fa-shapes"></i> 1. åŸºç¤èˆ‡é€²éš</strong><br>ã€ŒåŸºç¤é¡Œã€å¤šç‚ºå…·è±¡å¥½ç•«çš„æˆèªï¼›ã€Œé€²éšé¡Œã€å‰‡ç‚ºæŠ½è±¡æˆ–è¤‡é›œçš„æŒ‘æˆ°ã€‚</div>
            <div class="guide-section"><strong><i class="fas fa-brain"></i> 2. æ™ºæ…§ä¸é‡è¤‡</strong><br>ç³»çµ±æœƒè¨˜ä½é€™å°è£ç½®ç©éçš„é¡Œç›®ï¼Œç›´åˆ°é¡Œåº«ç”¨ç›¡ã€‚</div>
            <div class="guide-section"><strong><i class="fas fa-stopwatch"></i> 3. æ“ä½œå¯†æŠ€</strong><br>æ™‚é–“è¨­å®šå¯æŒ‰ä¸Šä¸‹éµå¢æ¸› 10 ç§’ã€‚éŠæˆ²ä¸­å¯æŒ‰ã€Œæ”¾æ£„ã€å›åˆ°é¦–é ã€‚</div>
            <div class="guide-section"><strong><i class="fas fa-trash-alt"></i> 4. é‡ç½®ç´€éŒ„</strong><br>è‹¥æƒ³é‡æ–°éŠç©æ‰€æœ‰é¡Œç›®ï¼Œè«‹é»æ“Šè¨­å®šé ä¸‹æ–¹çš„ã€Œæ¸…é™¤ç´€éŒ„ã€ã€‚</div>
            <button class="btn" onclick="closeGuide(null)" style="margin-top:10px;">
                <i class="fas fa-check"></i> æˆ‘çŸ¥é“äº†
            </button>
        </div>
    </div>

    <div id="setup-screen" class="variety-box">
        
        <div class="top-btn-group">
            <button class="circle-btn" id="demo-btn" onclick="startDemo()" title="è©¦ç©æ¨¡å¼ (Demo)">
                <i class="fas fa-gamepad"></i>
            </button>
            <button class="circle-btn" onclick="openGuide()" title="è¦å‰‡èªªæ˜">
                <i class="fas fa-question"></i>
            </button>
        </div>

        <h1>
            <i class="fas fa-palette"></i> 
            ä½ ç•«æˆ‘çŒœ 
            <span style="font-size:1.1rem; color:#888; font-weight:500; margin-top:8px;">æˆèªç‰ˆ</span>
        </h1>
        
        <div class="setting-group">
            <label><i class="fas fa-cubes"></i> åŸºç¤é¡Œæ•¸ (å…·è±¡)</label>
            <input type="number" id="basic-count" value="3" min="0">
            <span id="basic-remain" class="remain-hint">è¼‰å…¥ä¸­...</span>
        </div>

        <div class="setting-group">
            <label><i class="fas fa-layer-group"></i> é€²éšé¡Œæ•¸ (æŠ½è±¡)</label>
            <input type="number" id="adv-count" value="2" min="0">
            <span id="adv-remain" class="remain-hint">è¼‰å…¥ä¸­...</span>
        </div>

        <div class="setting-group">
            <label><i class="fas fa-hourglass-half"></i> å€’æ•¸æ™‚é–“ (ç§’)</label>
            <input type="number" id="timer-set" value="20" min="10" step="10">
        </div>

        <div class="switch-container active" onclick="toggleBGMSetup()" id="setup-bgm-switch">
            <div class="toggle-box"><div class="toggle-circle"></div></div>
            <span><i class="fas fa-music"></i> èƒŒæ™¯éŸ³æ¨‚ (BGM)</span>
        </div>

        <button class="btn" onclick="startGame()">
            <i class="fas fa-play"></i> é–‹å§‹æŒ‘æˆ°
        </button>
        
        <div class="reload-link" onclick="resetHistory()">
            <i class="fas fa-trash-alt"></i> æ¸…é™¤å·²ç©ç´€éŒ„ (é‡ç½®é¡Œåº«)
        </div>
    </div>

    <div id="game-screen" class="variety-box">
        <div id="demo-ribbon" class="demo-ribbon">ğŸš§ è©¦ç©æ¨¡å¼</div>

        <div class="status-bar">
            <span id="level-tag" style="color:var(--secondary-dark);">
                <i class="fas fa-tag"></i> åŸºç¤é¡Œ
            </span>
            <span id="progress-text">1 / 5</span>
        </div>

        <div id="question-display">æº–å‚™ä¸­...</div>
        
        <div class="timer-box" id="timer-display">
            <i class="fas fa-clock"></i> --
        </div>

        <button class="btn btn-blue" id="timer-btn" onclick="toggleTimer()">
            <i class="fas fa-stopwatch"></i> é–‹å§‹è¨ˆæ™‚
        </button>
        
        <button class="btn" id="next-btn" onclick="nextQuestion()">
            ä¸‹ä¸€é¡Œ <i class="fas fa-chevron-right"></i>
        </button>
        
        <div style="margin-top: 15px;">
            <div class="switch-container active" onclick="toggleBGMGame()" id="game-bgm-switch">
                <div class="toggle-box"><div class="toggle-circle"></div></div>
                <span><i class="fas fa-music"></i> BGM</span>
            </div>
        </div>

        <button class="btn-quit" onclick="confirmQuit()">
            <i class="fas fa-undo"></i> æ”¾æ£„æœ¬å±€ / å›åˆ°è¨­å®š
        </button>
    </div>

    <script>
        // --- éŠæˆ²ç‹€æ…‹ ---
        let gameQueue = [];
        let currentIndex = -1;
        let timerDuration = 60;
        let timerInterval = null;
        let isBGMOn = true; // é è¨­é–‹å•Ÿ BGM
        let audioContext = null;
        let playedHistory = JSON.parse(localStorage.getItem('playedIdiomsHistory')) || [];
        let isDemoMode = false;

        // --- DOM ---
        const setupScreen = document.getElementById('setup-screen');
        const gameScreen = document.getElementById('game-screen');
        const bgmPlayer = document.getElementById('bgm-player');
        const questionDisplay = document.getElementById('question-display');
        const progressText = document.getElementById('progress-text');
        const levelTag = document.getElementById('level-tag');
        const timerDisplay = document.getElementById('timer-display');
        const timerBtn = document.getElementById('timer-btn');
        const nextBtn = document.getElementById('next-btn');
        const guideModal = document.getElementById('guide-modal');
        const basicRemainLabel = document.getElementById('basic-remain');
        const advRemainLabel = document.getElementById('adv-remain');
        const demoRibbon = document.getElementById('demo-ribbon');

        // --- æª¢æŸ¥é¡Œåº« ---
        if (typeof db_basic === 'undefined' || typeof db_advanced === 'undefined') {
            alert("âš ï¸ éŒ¯èª¤ï¼šæ‰¾ä¸åˆ°é¡Œåº«æª”æ¡ˆ questions.jsï¼\nè«‹ç¢ºèª index.html èˆ‡ questions.js æ”¾åœ¨åŒä¸€å€‹è³‡æ–™å¤¾å…§ã€‚");
        }

        function updateRemainCounts() {
            if (typeof db_basic === 'undefined') return;
            const availableBasic = db_basic.filter(q => !playedHistory.includes(q));
            const availableAdv = db_advanced.filter(q => !playedHistory.includes(q));
            basicRemainLabel.innerText = `(å°šæœ‰ ${availableBasic.length} é¡Œæœªç©é)`;
            advRemainLabel.innerText = `(å°šæœ‰ ${availableAdv.length} é¡Œæœªç©é)`;
        }
        updateRemainCounts();

        function openGuide() { guideModal.style.display = 'flex'; }
        function closeGuide(event) { if (event === null || event.target === guideModal) guideModal.style.display = 'none'; }

        // --- è©¦ç©æ¨¡å¼ ---
        function startDemo() {
            if(!confirm("ã€è©¦ç©æ¨¡å¼èªªæ˜ã€‘\n\n1. æ­¤æ¨¡å¼ä¸æœƒæ¶ˆè€—æ­£å¼é¡Œåº«ã€‚\n2. åƒ…æä¾› 2 é¡Œç¯„ä¾‹ (åŸºç¤/é€²éšå„ä¸€)ã€‚\n3. æ¯é¡Œæ™‚é–“å›ºå®šç‚º 8 ç§’ï¼Œç”¨æ–¼ç†Ÿæ‚‰å€’æ•¸éŸ³æ•ˆã€‚\n\næº–å‚™å¥½è¦é–‹å§‹è©¦ç©äº†å—ï¼Ÿ")) {
                return;
            }
            gameQueue = [
                {text: "ä¸€äº”ä¸€å", type: "åŸºç¤ç¯„ä¾‹", color: "var(--secondary-dark)"},
                {text: "ä¸ƒä¸Šå…«ä¸‹", type: "é€²éšç¯„ä¾‹", color: "var(--accent-color)"}
            ];
            timerDuration = 8;
            isDemoMode = true;
            setupScreen.style.display = 'none';
            gameScreen.style.display = 'block';
            demoRibbon.style.display = 'block';
            if (!audioContext) audioContext = new (window.AudioContext || window.webkitAudioContext)();
            if (isBGMOn) bgmPlayer.play().catch(e => console.log("User interaction needed for BGM"));
            nextQuestion();
        }

        // --- 1. é–‹å§‹éŠæˆ² ---
        function startGame() {
            const basicCount = parseInt(document.getElementById('basic-count').value) || 0;
            const advCount = parseInt(document.getElementById('adv-count').value) || 0;
            timerDuration = parseInt(document.getElementById('timer-set').value) || 20;

            if (basicCount + advCount === 0) { alert("è«‹è‡³å°‘è¨­å®šä¸€é¡Œï¼"); return; }

            const availableBasic = db_basic.filter(q => !playedHistory.includes(q));
            const availableAdv = db_advanced.filter(q => !playedHistory.includes(q));

            if (basicCount > availableBasic.length || advCount > availableAdv.length) {
                alert(`é¡Œåº«å­˜é‡ä¸è¶³ï¼\n\nåŸºç¤é¡Œå‰©: ${availableBasic.length}\né€²éšé¡Œå‰©: ${availableAdv.length}\n\nè«‹æ¸›å°‘è¨­å®šæ•¸é‡ã€‚`);
                return;
            }

            const finalBasic = shuffleArray([...availableBasic]).slice(0, basicCount).map(t => ({text: t, type: 'åŸºç¤é¡Œ', color: 'var(--secondary-dark)'}));
            const finalAdv = shuffleArray([...availableAdv]).slice(0, advCount).map(t => ({text: t, type: 'é€²éšé¡Œ', color: 'var(--accent-color)'}));
            
            gameQueue = [...finalBasic, ...finalAdv];
            isDemoMode = false;

            if (!audioContext) audioContext = new (window.AudioContext || window.webkitAudioContext)();
            setupScreen.style.display = 'none';
            gameScreen.style.display = 'block';
            demoRibbon.style.display = 'none';
            
            if (isBGMOn) bgmPlayer.play().catch(e => console.log("User interaction needed for BGM"));

            nextQuestion();
        }

        // --- 2. é¡Œç›®æ§åˆ¶ ---
        function nextQuestion() {
            stopTimer();
            timerDisplay.innerHTML = '<i class="fas fa-clock"></i> ' + timerDuration;
            timerDisplay.classList.remove('timer-warning');
            
            timerBtn.innerHTML = '<i class="fas fa-stopwatch"></i> é–‹å§‹è¨ˆæ™‚';
            timerBtn.disabled = false;
            timerBtn.classList.add('btn-blue');
            timerBtn.style.background = ""; 

            currentIndex++;

            if (currentIndex >= gameQueue.length) {
                let endText = isDemoMode ? "è©¦ç©çµæŸ" : "æŒ‘æˆ°çµæŸ";
                questionDisplay.innerHTML = `<span style='font-size: 2.5rem; color:var(--accent-color);'><i class='fas fa-flag-checkered'></i> ${endText}ï¼</span>`;
                progressText.innerText = "END"; levelTag.innerHTML = "";
                nextBtn.innerHTML = isDemoMode ? "<i class='fas fa-home'></i> å›è¨­å®šé " : "<i class='fas fa-redo'></i> æ–°çš„ä¸€å±€";
                nextBtn.onclick = () => location.reload();
                timerBtn.disabled = true;
                timerBtn.classList.remove('btn-blue');
                timerBtn.style.background = "#ccc";
                return;
            }

            const q = gameQueue[currentIndex];
            questionDisplay.innerText = q.text;

            if (!isDemoMode) {
                playedHistory.push(q.text);
                localStorage.setItem('playedIdiomsHistory', JSON.stringify(playedHistory));
            }
            
            const isMobile = window.innerWidth < 600;
            if (q.text.length > 5) {
                questionDisplay.style.fontSize = isMobile ? "2.5rem" : "3.5rem";
            } else {
                questionDisplay.style.fontSize = isMobile ? "3.5rem" : "5rem";
            }

            progressText.innerText = `${currentIndex + 1} / ${gameQueue.length}`;
            levelTag.innerHTML = `<i class="fas fa-tag"></i> ${q.type}`;
            levelTag.style.color = q.color;
        }

        // --- 3. è¨ˆæ™‚å™¨èˆ‡éŸ³æ•ˆ ---
        function toggleTimer() {
            if (timerInterval) { stopTimer(); return; }
            let timeLeft = timerDuration;
            timerDisplay.innerHTML = '<i class="fas fa-clock"></i> ' + timeLeft;
            
            timerBtn.innerHTML = '<i class="fas fa-pause"></i> åœæ­¢';
            timerBtn.classList.remove('btn-blue'); 
            timerBtn.style.background = "#57606f";
            
            timerInterval = setInterval(() => {
                timeLeft--;
                timerDisplay.innerHTML = '<i class="fas fa-clock"></i> ' + timeLeft;

                if (timeLeft <= 5 && timeLeft > 0) {
                    timerDisplay.classList.add('timer-warning');
                    let pitch = 880 + (5 - timeLeft) * 50; 
                    playBeep(pitch, 0.15, 'square', 0.5); 
                } else if (timeLeft === 0) {
                    playBeep(200, 1.5, 'sawtooth', 1.0); 
                    timerDisplay.innerHTML = '<i class="fas fa-times-circle"></i> æ™‚é–“åˆ°';
                    stopTimer();
                    timerBtn.innerHTML = '<i class="fas fa-stopwatch"></i> é–‹å§‹è¨ˆæ™‚';
                    timerBtn.disabled = true;
                    timerBtn.style.background = "#ccc";
                }
            }, 1000);
        }

        function stopTimer() { 
            clearInterval(timerInterval); 
            timerInterval = null; 
            timerDisplay.classList.remove('timer-warning'); 
            if(!timerBtn.disabled) {
                timerBtn.innerHTML = '<i class="fas fa-stopwatch"></i> é–‹å§‹è¨ˆæ™‚';
                timerBtn.classList.add('btn-blue');
                timerBtn.style.background = ""; 
            }
        }

        function playBeep(frequency, duration, type = 'sine', volume = 1.0) {
            if (!audioContext) return;
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            oscillator.type = type;
            oscillator.frequency.value = frequency;
            gainNode.gain.setValueAtTime(volume, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + duration);
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            oscillator.start();
            oscillator.stop(audioContext.currentTime + duration);
        }

        function toggleBGMSetup() { isBGMOn = !isBGMOn; updateSwitchUI('setup-bgm-switch', isBGMOn); updateSwitchUI('game-bgm-switch', isBGMOn); }
        function toggleBGMGame() { isBGMOn = !isBGMOn; updateSwitchUI('setup-bgm-switch', isBGMOn); updateSwitchUI('game-bgm-switch', isBGMOn); if (isBGMOn) bgmPlayer.play(); else bgmPlayer.pause(); }
        
        function updateSwitchUI(id, isOn) { 
            const container = document.getElementById(id); // æ­¤è™•ä¿®æ­£ç‚ºæŠ“å– container
            if (isOn) {
                container.classList.add('active'); 
            } else {
                container.classList.remove('active');
            }
        }
        
        function shuffleArray(array) { for (let i = array.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [array[i], array[j]] = [array[j], array[i]]; } return array; }

        function resetHistory() {
            if (confirm("ã€ç¢ºèªã€‘\nç¢ºå®šè¦æ¸…é™¤ç´€éŒ„å—ï¼Ÿ\næ¸…é™¤å¾Œï¼Œæˆèªå°‡æœƒé‡æ–°é‡è¤‡å‡ºç¾ã€‚")) {
                localStorage.removeItem('playedIdiomsHistory');
                alert("ç´€éŒ„å·²æ¸…é™¤ï¼");
                location.reload();
            }
        }

        function confirmQuit() {
            if (confirm("éŠæˆ²æ­£åœ¨é€²è¡Œä¸­ï¼Œç¢ºå®šè¦æ”¾æ£„ä¸¦å›åˆ°è¨­å®šé å—ï¼Ÿ")) {
                location.reload();
            }
        }
    </script>
</body>
</html>