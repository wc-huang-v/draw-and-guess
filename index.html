<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å‹‡è€…é¬¥æƒ¡é¾é¢¨ - é¡Œç›®ç”Ÿæˆå™¨</title>
    <link href="https://fonts.googleapis.com/css2?family=DotGothic16&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color: #000000;
            --border-color: #ffffff;
            --text-color: #ffffff;
            --highlight: #f1c40f; /* é‡‘å¹£è‰² */
            --danger: #e74c3c;
        }

        * {
            box-sizing: border-box;
            user-select: none;
        }

        body {
            font-family: 'DotGothic16', 'Microsoft JhengHei', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
        }

        /* --- DQ é¢¨æ ¼è¦–çª— --- */
        .dq-box {
            border: 4px solid var(--border-color);
            border-radius: 8px;
            padding: 20px;
            background-color: #000;
            position: relative;
            box-shadow: 0 0 0 2px #000, 0 0 0 6px var(--border-color);
            margin-bottom: 20px;
            width: 100%;
            max-width: 600px;
        }

        h1 {
            color: var(--highlight);
            text-align: center;
            margin-top: 0;
            text-shadow: 2px 2px #e67e22;
        }

        /* --- è¨­å®šé é¢ --- */
        .setting-group {
            margin-bottom: 15px;
            font-size: 1.2rem;
        }

        label {
            display: block;
            margin-bottom: 5px;
        }

        input[type="number"] {
            width: 100%;
            background: #000;
            color: #fff;
            border: 2px solid #fff;
            padding: 10px;
            font-family: inherit;
            font-size: 1.2rem;
            text-align: center;
        }

        /* --- æŒ‰éˆ•æ¨£å¼ --- */
        .btn {
            background: #000;
            color: #fff;
            border: 2px solid #fff;
            padding: 15px 30px;
            font-family: inherit;
            font-size: 1.3rem;
            cursor: pointer;
            width: 100%;
            margin-top: 10px;
            transition: all 0.1s;
            position: relative;
        }

        .btn:hover {
            background: #222;
            color: var(--highlight);
        }

        .btn:active {
            transform: translate(2px, 2px);
        }

        .btn::before {
            content: "â–¶";
            position: absolute;
            left: 15px;
            opacity: 0;
            transition: opacity 0.1s;
        }
        .btn:hover::before { opacity: 1; }

        /* --- éŠæˆ²é é¢ (é è¨­éš±è—) --- */
        #game-screen {
            display: none;
            text-align: center;
        }

        .status-bar {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
            font-size: 1rem;
            color: #bdc3c7;
        }

        #question-display {
            font-size: 3rem;
            min-height: 150px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--highlight);
            text-shadow: 3px 3px #c0392b;
            line-height: 1.2;
        }

        .timer-box {
            font-size: 2rem;
            margin: 15px 0;
            padding: 10px;
            border: 2px dashed #555;
        }

        .timer-warning {
            color: var(--danger);
            animation: blink 0.5s infinite;
        }

        @keyframes blink { 50% { opacity: 0; } }

        .switch-container {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-top: 20px;
            font-size: 0.9rem;
            cursor: pointer;
        }

        .toggle-box {
            width: 20px;
            height: 20px;
            border: 2px solid #fff;
            margin-right: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .toggle-check {
            width: 10px;
            height: 10px;
            background: var(--highlight);
            display: none;
        }

        .active .toggle-check { display: block; }

        /* --- æŒ‡å—æŒ‰éˆ•èˆ‡å½ˆçª— (æ–°åŠŸèƒ½) --- */
        #guide-btn {
            position: fixed;
            top: 15px;
            right: 15px;
            z-index: 1000;
            background: #000;
            color: #fff;
            border: 2px solid #fff;
            padding: 8px 15px;
            font-family: inherit;
            cursor: pointer;
            box-shadow: 0 0 0 2px #000, 0 0 0 4px #fff;
            font-size: 1rem;
        }

        #guide-btn:hover { background: #333; }

        /* é®ç½©å±¤ */
        .modal-overlay {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 2000;
            display: none; /* é è¨­éš±è— */
            align-items: center;
            justify-content: center;
        }

        /* å½ˆçª—æœ¬é«” */
        .modal-box {
            background: #000;
            border: 4px solid #fff;
            box-shadow: 0 0 0 2px #000, 0 0 0 6px #fff;
            padding: 20px;
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
            position: relative;
            text-align: left;
        }

        .modal-title {
            color: var(--highlight);
            text-align: center;
            font-size: 1.5rem;
            margin-bottom: 20px;
            border-bottom: 2px dashed #555;
            padding-bottom: 10px;
        }

        .guide-section {
            margin-bottom: 15px;
            font-size: 1rem;
            line-height: 1.6;
        }

        .guide-section strong {
            color: #3498db; /* å‹‡è€…è— */
        }

        .close-btn {
            display: block;
            margin: 20px auto 0;
            width: 50%;
            text-align: center;
        }

    </style>
</head>
<body>

    <audio id="bgm-player" loop>
        <source src="bg-music.mp3" type="audio/mpeg">
    </audio>

    <button id="guide-btn" onclick="openGuide()">ğŸ“œ å†’éšªæŒ‡å—</button>

    <div id="guide-modal" class="modal-overlay" onclick="closeGuide(event)">
        <div class="modal-box" onclick="event.stopPropagation()">
            <div class="modal-title">âš”ï¸ å‹‡è€…æ“ä½œæ‰‹å†Š</div>
            
            <div class="guide-section">
                <strong>1. æº–å‚™éšæ®µ (Setup)</strong><br>
                â€¢ å»ºè­°ä½¿ç”¨é›»è…¦é€£æ¥é›»è¦–ï¼Œä¸¦æŒ‰ä¸‹ <strong>F11</strong> é€²å…¥å…¨è¢å¹•æ¨¡å¼ï¼Œé«”é©—æœ€ä½³ã€‚<br>
                â€¢ è«‹å…ˆåœ¨è¨­å®šé é¢è¼¸å…¥æ‚¨æƒ³è¦çš„é¡Œç›®æ•¸é‡ã€‚
            </div>

            <div class="guide-section">
                <strong>2. éŠæˆ²é€²è¡Œ (Quest)</strong><br>
                â€¢ é»æ“Š <strong>ã€Œä¸‹ä¸€é¡Œã€</strong> æŠ½å–æ–°çš„æŒ‘æˆ°ã€‚<br>
                â€¢ é»æ“Š <strong>ã€Œé–‹å§‹è¨ˆæ™‚ã€</strong> å•Ÿå‹•å€’æ•¸ã€‚<br>
                â€¢ å€’æ•¸æœ€å¾Œ 5 ç§’æœƒæœ‰ã€Œå—¶å—¶ã€è²æç¤ºï¼Œæ™‚é–“åˆ°æœƒæœ‰é•·è²è­¦ç¤ºã€‚
            </div>

            <div class="guide-section">
                <strong>3. éŸ³æ¨‚èˆ‡éŸ³æ•ˆ (Sound)</strong><br>
                â€¢ èƒŒæ™¯éŸ³æ¨‚ (BGM) å¯éš¨æ™‚ç”±ä¸‹æ–¹çš„é–‹é—œåˆ‡æ›ã€‚<br>
                â€¢ å€’æ•¸éŸ³æ•ˆç‚ºç³»çµ±è‡ªå‹•åˆæˆï¼Œç„¡é ˆé¡å¤–ä¸‹è¼‰æª”æ¡ˆã€‚
            </div>

            <div class="guide-section">
                <strong>4. é‡ç½®éŠæˆ²</strong><br>
                â€¢ è‹¥é¡Œç›®æŠ½å®Œæˆ–æƒ³é‡æ–°è¨­å®šï¼Œè«‹é»æ“Šç•«é¢æœ€ä¸‹æ–¹çš„ã€Œé‡æ–°è¼‰å…¥ã€æ–‡å­—ã€‚
            </div>

            <button class="btn close-btn" onclick="closeGuide(null)">æˆ‘çŸ¥é“äº†</button>
        </div>
    </div>

    <div id="setup-screen" class="dq-box">
        <h1>âš”ï¸ å†’éšªè¨­ç½® âš”ï¸</h1>
        
        <div class="setting-group">
            <label>åŸºç¤é¡Œæ•¸ (Basic):</label>
            <input type="number" id="basic-count" value="10" min="0">
        </div>

        <div class="setting-group">
            <label>é€²éšé¡Œæ•¸ (Advanced):</label>
            <input type="number" id="adv-count" value="5" min="0">
        </div>

        <div class="setting-group">
            <label>å€’æ•¸è¨ˆæ™‚ (ç§’):</label>
            <input type="number" id="timer-set" value="60" min="10">
        </div>

        <div class="switch-container" onclick="toggleBGMSetup()" id="setup-bgm-switch">
            <div class="toggle-box active"><div class="toggle-check"></div></div>
            <span>èƒŒæ™¯éŸ³æ¨‚ (BGM)</span>
        </div>

        <button class="btn" onclick="startGame()">é–‹å§‹å†’éšª</button>
    </div>

    <div id="game-screen" class="dq-box">
        <div class="status-bar">
            <span id="progress-text">Quest 1/15</span>
            <span id="level-tag">ç­‰ç´š: åŸºç¤</span>
        </div>

        <div id="question-display">æº–å‚™ä¸­...</div>

        <div class="timer-box" id="timer-display">--</div>

        <button class="btn" id="timer-btn" onclick="toggleTimer()">â±ï¸ é–‹å§‹è¨ˆæ™‚</button>
        <button class="btn" id="next-btn" onclick="nextQuestion()">âš”ï¸ ä¸‹ä¸€é¡Œ</button>
        
        <div class="switch-container" onclick="toggleBGMGame()" id="game-bgm-switch">
            <div class="toggle-box active"><div class="toggle-check"></div></div>
            <span>BGM é–‹é—œ</span>
        </div>
        
        <div style="margin-top:15px; font-size: 0.8rem; color:#555; cursor:pointer;" onclick="location.reload()">
            [é‡æ–°è¼‰å…¥/æ¸…é™¤ç´€éŒ„]
        </div>
    </div>

    <script>
        // --- é¡Œåº«è³‡æ–™ ---
        const db_basic = [
            "çç å¥¶èŒ¶", "è‡­è±†è…", "é¹¹é…¥é›", "å¤§è…¸åŒ…å°è…¸", "æ»·è‚‰é£¯", "é›æ’", "è±¬è¡€ç³•", "åœ°ç“œçƒ", "èšµä»”ç…", "å°ç± åŒ…",
            "ç‰›è‚‰éºµ", "èŠ’æœå†°", "æœ¨ç“œç‰›å¥¶", "æ—©é¤åº—å¥¶èŒ¶", "åƒåˆ°é£½", "è¿´è½‰å£½å¸", "è–‘æ¯é´¨", "ç¾Šè‚‰çˆ", "éº»è¾£é‹", "é¼æ³°è±",
            "éº¥ç•¶å‹", "è‚¯å¾·åŸº", "å¿…å‹å®¢", "ä¸¹ä¸¹æ¼¢å ¡", "æ°¸å’Œè±†æ¼¿", "ç†±ç‚’åº—", "æµæ°´å¸­", "è¾¦æ¡Œ", "é³³æ¢¨é…¥", "è»Šè¼ªé¤…",
            "è¿½åƒåœ¾è»Š", "é¨æ©Ÿè»Š", "æˆ´å®‰å…¨å¸½", "å…©æ®µå¼å·¦è½‰", "æ‰¾åœè»Šä½", "è¢«é–‹ç½°å–®", "æ‹–åŠè»Š", "å¡è»Š", "æ·é‹è®“åº§", "åšæ„›åº§",
            "æ‚ éŠå¡", "YouBike", "å¤¾å¨ƒå¨ƒæ©Ÿ", "ä¾¿åˆ©å•†åº—", "è«‹æ”¯æ´æ”¶éŠ€", "è¦çš®åº—åˆ°åº—", "çµ±ä¸€ç™¼ç¥¨", "ä¸­ç", "åˆ®åˆ®æ¨‚", "å¨åŠ›å½©",
            "å€’åƒåœ¾", "ç­‰ç´…ç¶ ç‡ˆ", "è¡Œäººåœ°ç„", "ä¸‰å¯¶", "é…’æ¸¬", "å«å¤–é€", "UberEats", "è–ªæ°´å°å·", "æ…£è€é—†", "è²¬ä»»åˆ¶",
            "åŠ ç­è²»", "çœ¼ç¥æ­»", "æƒ…ç·’å‹’ç´¢", "åª½å¯¶", "å…¬ä¸»ç—…", "æ¸£ç”·", "æšˆèˆ¹", "é‚Šç·£äºº", "ç¤¾ç•œ", "èººå¹³",
            "å¹´çµ‚çé‡‘", "å°¾ç‰™", "å±…å®¶è¾¦å…¬", "è¦–è¨Šæœƒè­°", "å·²è®€ä¸å›", "æŒ‰è®šåˆ†äº«", "ç¶²ç¾æ™¯é»", "ä¿®åœ–", "é¢±é¢¨å‡", "åœ°éœ‡",
            "åœé›»", "å»æ‹œæ‹œ", "æ”¶é©š", "æ“²ç­Š", "æ±‚ç±¤", "å®‰å¤ªæ­²", "æ¶é ­é¦™", "åŒ…ç´…åŒ…", "å–å–œé…’", "æ‰“éº»å°‡",
            "æ»‘æ‰‹æ©Ÿ", "è‡ªæ‹", "æŒ–é¼»å­”", "å‰ªæŒ‡ç”²", "åˆ·ç‰™æ´—è‡‰", "ä¸Šå»æ‰€æ²’ç´™", "æ´—æ¾¡å”±æ­Œ", "é‡é«”æº«", "åšå¿«ç¯©", "æ‰“ç–«è‹—",
            "æ’éšŠ", "æ’éšŠ", "æ‰“æ¶", "å ±è­¦", "å«æ•‘è­·è»Š", "çœ‹ç‰™é†«", "æ¸›è‚¥", "ä¼åœ°æŒºèº«", "ä»°è‡¥èµ·å", "æ·±è¹²"
        ];

        const db_advanced = [
            "ç•«è›‡æ·»è¶³", "å°ç‰›å½ˆç´", "é›é£›ç‹—è·³", "ç‹å‡è™å¨", "äº•åº•ä¹‹è›™", "å®ˆæ ªå¾…å…”", "äº¡ç¾Šè£œç‰¢", "é¶´ç«‹é›ç¾¤", "ç›²äººæ‘¸è±¡", "é­šç›®æ··ç ",
            "æŒ‡é¹¿ç‚ºé¦¬", "ç‹¼ç‹½ç‚ºå¥¸", "ç‹—æ€¥è·³ç‰†", "æ®ºé›å„†çŒ´", "é¨è™é›£ä¸‹", "é©šå¼“ä¹‹é³¥", "å¦‚é­šå¾—æ°´", "é¾é£›é³³èˆ", "ç¬¨é³¥å…ˆé£›", "å¼•ç‹¼å…¥å®¤",
            "æ‰“è‰é©šè›‡", "èª¿è™é›¢å±±", "è‘‰å…¬å¥½é¾", "é›é³´ç‹—ç›œ", "é³³æ¯›éºŸè§’", "æ©è€³ç›œéˆ´", "æ‹”è‹—åŠ©é•·", "åˆ»èˆŸæ±‚åŠ", "è² èŠè«‹ç½ª", "ç­é–€å¼„æ–§",
            "è‰èˆ¹å€Ÿç®­", "æ‡¸æ¢åˆºè‚¡", "èé›èµ·èˆ", "é‘¿å£å·å…‰", "æ±æ–½æ•ˆé¡°", "é †æ‰‹ç‰½ç¾Š", "æŠ±é ­é¼ ç«„", "å¼µç‰™èˆçˆª", "æ‰‹èˆè¶³è¹ˆ", "æ“ çœ‰å¼„çœ¼",
            "æ€’é«®è¡å† ", "å‚é ­å–ªæ°£", "ç›®çªå£å‘†", "ä¸ƒç«…ç”Ÿç…™", "æ§è…¹å¤§ç¬‘", "å“­ç¬‘ä¸å¾—", "é¢ç´…è€³èµ¤", "å’¬ç‰™åˆ‡é½’", "æ„çœ‰è‹¦è‡‰", "çœ‰é–‹çœ¼ç¬‘",
            "éª¨ç˜¦å¦‚æŸ´", "å¤§è…¹ä¾¿ä¾¿", "é ­ç ´è¡€æµ", "å¿ƒå¦‚åˆ€å‰²", "æ±—å¦‚é›¨ä¸‹", "ç†±é‹èèŸ»", "å‘†è‹¥æœ¨é›", "å£è‹¥æ‡¸æ²³", "å¤§åƒä¸€é©š", "ä¸€ç®­é›™éµ°",
            "ç™¾æ­¥ç©¿æ¥Š", "æ¯å¼“è›‡å½±", "éµæ¨¹é–‹èŠ±", "é¡èŠ±æ°´æœˆ", "é–€å¯ç¾…é›€", "é«˜æ¨“å¤§å»ˆ", "è»Šæ°´é¦¬é¾", "æ°´æ»´çŸ³ç©¿", "æ›‡èŠ±ä¸€ç¾", "å‹¢å¦‚ç ´ç«¹",
            "ä¸€åˆ€å…©æ–·", "æ”¯é›¢ç ´ç¢", "è—•æ–·çµ²é€£", "éŒ¦ä¸Šæ·»èŠ±", "é›ªä¸­é€ç‚­", "ç«ä¸ŠåŠ æ²¹", "å¦‚å±¥è–„å†°", "æ³°å±±å£“é ‚", "ä¸€çŸ³äºŒé³¥", "ç•«é¤…å……é£¢",
            "æœ›æ¢…æ­¢æ¸´", "é£›è›¾æ’²ç«", "è³è‡‚æ“‹è»Š", "ç·£æœ¨æ±‚é­š", "ç”•ä¸­æ‰é±‰", "è‡ªæŠ•ç¾…ç¶²", "é‡‘èŸ¬è„«æ®¼", "é³©ä½”éµ²å·¢", "è€é¦¬è­˜é€”", "ä¸‰é ­å…­è‡‚",
            "ç•°æƒ³å¤©é–‹", "æƒ³å…¥éé", "å¿ƒä¸åœ¨ç„‰", "å†¥æ€è‹¦æƒ³", "çŒ¶è±«ä¸æ±º", "æå¿ƒåŠè†½", "å¿ƒèŠ±æ€’æ”¾", "æƒ±ç¾æˆæ€’", "å¹¸ç½æ¨‚ç¦", "æäººæ†‚å¤©",
            "å‰›æ„è‡ªç”¨", "å„ªæŸ”å¯¡æ–·", "è‡ªä½œå¤šæƒ…", "æç„¶å¤§æ‚Ÿ", "é­‚é£›é­„æ•£", "ä¸å¯æ€è­°", "è«åå…¶å¦™", "å–œå‡ºæœ›å¤–", "æ¨‚ä¸æ€èœ€", "æ­¸å¿ƒä¼¼ç®­",
            "é›åŒé´¨è¬›", "ç«Šç«Šç§èª", "å–‹å–‹ä¸ä¼‘", "å”‡æ§èˆŒåŠ", "ç”œè¨€èœœèª", "æ¬å¼„æ˜¯é", "çœ¾å£é‘ é‡‘", "éœ‡è€³æ¬²è¾", "é´‰é›€ç„¡è²", "ç•°å£åŒè²",
            "æ¨ä¸‰é˜»å››", "å‹¾å¿ƒæ–—è§’", "çˆ¾è™æˆ‘è©", "çœ¾å›è¦ªé›¢", "æ ¼æ ¼ä¸å…¥", "è‡ªç›¸çŸ›ç›¾", "é€²é€€å…©é›£", "æœ¬æœ«å€’ç½®", "é›ªä¸ŠåŠ éœœ", "çµ•è™•é€¢ç”Ÿ",
            "ä¸‰å€‹è‡­çš®åŒ ", "çè²“ç¢°ä¸Šæ­»è€—å­", "é›è›‹è£¡æŒ‘éª¨é ­", "è–‘æ˜¯è€çš„è¾£", "ç‹—å˜´åä¸å‡ºè±¡ç‰™",
            "ç™©è›¤èŸ†æƒ³åƒå¤©éµè‚‰", "æ­¤åœ°ç„¡éŠ€ä¸‰ç™¾å…©", "è³ äº†å¤«äººåˆæŠ˜å…µ", "ä¸è¦‹æ£ºæä¸æ‰æ·š", "åƒä¸åˆ°è‘¡è„èªªè‘¡è„é…¸",
            "ç•™å¾—é’å±±åœ¨ä¸æ€•æ²’æŸ´ç‡’", "ä¸€æœè¢«è›‡å’¬åå¹´æ€•è‰ç¹©", "å·é›ä¸è‘—è•æŠŠç±³", "äº•æ°´ä¸çŠ¯æ²³æ°´", "äº”åæ­¥ç¬‘ç™¾æ­¥",
            "æ‰“ç ´ç ‚é‹å•åˆ°åº•", "æƒ¡äººå…ˆå‘Šç‹€", "äººä¸å¯è²Œç›¸", "å…«å­—é‚„æ²’ä¸€æ’‡", "å¤©ä¸‹æ²’æœ‰ç™½åƒçš„åˆé¤"
        ];

        // --- éŠæˆ²ç‹€æ…‹ ---
        let gameQueue = [];
        let currentIndex = -1;
        let timerDuration = 60;
        let timerInterval = null;
        let isBGMOn = true;
        let audioContext = null;

        // --- DOM ---
        const setupScreen = document.getElementById('setup-screen');
        const gameScreen = document.getElementById('game-screen');
        const bgmPlayer = document.getElementById('bgm-player');
        const questionDisplay = document.getElementById('question-display');
        const progressText = document.getElementById('progress-text');
        const levelTag = document.getElementById('level-tag');
        const timerDisplay = document.getElementById('timer-display');
        const timerBtn = document.getElementById('timer-btn');
        const nextBtn = document.getElementById('next-btn');
        const guideModal = document.getElementById('guide-modal');

        // --- æŒ‡å—é–‹é—œé‚è¼¯ ---
        function openGuide() {
            guideModal.style.display = 'flex';
        }

        function closeGuide(event) {
            // å¦‚æœæœ‰é»æ“Šäº‹ä»¶ï¼Œä¸”é»æ“Šçš„æ˜¯é®ç½©å±¤æœ¬èº«(overlay)æˆ–æŒ‰éˆ•ï¼Œæ‰é—œé–‰
            // é»æ“Šå°è©±æ¡†å…§å®¹(box)ä¸æœƒé—œé–‰
            if (event === null || event.target === guideModal) {
                guideModal.style.display = 'none';
            }
        }

        // --- 1. åˆå§‹åŒ–èˆ‡é–‹å§‹éŠæˆ² ---
        function startGame() {
            const basicCount = parseInt(document.getElementById('basic-count').value) || 0;
            const advCount = parseInt(document.getElementById('adv-count').value) || 0;
            timerDuration = parseInt(document.getElementById('timer-set').value) || 60;

            if (basicCount > db_basic.length || advCount > db_advanced.length) {
                alert(`å‹‡è€…å•Šï¼é¡Œåº«å­˜é‡ä¸è¶³ï¼\n\nç›®å‰æ“æœ‰ï¼š\nåŸºç¤é¡Œ ${db_basic.length} é¡Œ\né€²éšé¡Œ ${db_advanced.length} é¡Œ\n\nè«‹æ¸›å°‘è¨­å®šæ•¸é‡æˆ–æŒ‰ä¸‹æ–¹çš„ã€Œé‡æ–°è¼‰å…¥ã€æ¸…é™¤æ­·å²ç´€éŒ„ã€‚`);
                return;
            }
            if (basicCount + advCount === 0) {
                alert("è«‹è‡³å°‘è¨­å®šä¸€é¡Œæ‰èƒ½é–‹å§‹å†’éšªï¼");
                return;
            }

            const selectedBasic = shuffleArray([...db_basic]).slice(0, basicCount).map(t => ({text: t, type: 'åŸºç¤'}));
            const selectedAdv = shuffleArray([...db_advanced]).slice(0, advCount).map(t => ({text: t, type: 'é€²éš'}));
            gameQueue = shuffleArray([...selectedBasic, ...selectedAdv]);

            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }

            setupScreen.style.display = 'none';
            gameScreen.style.display = 'block';

            if (isBGMOn) {
                bgmPlayer.volume = 0.5;
                bgmPlayer.play().catch(e => console.log("BGM Autoplay blocked"));
            }

            nextQuestion();
        }

        // --- 2. é¡Œç›®æ§åˆ¶ ---
        function nextQuestion() {
            stopTimer();
            timerDisplay.innerText = timerDuration;
            timerDisplay.classList.remove('timer-warning');
            timerBtn.innerText = "â±ï¸ é–‹å§‹è¨ˆæ™‚";
            timerBtn.disabled = false;

            currentIndex++;

            if (currentIndex >= gameQueue.length) {
                questionDisplay.innerText = "ğŸ‰ ä»»å‹™å®Œæˆï¼";
                progressText.innerText = "END";
                levelTag.innerText = "-";
                nextBtn.innerText = "é‡æ–°é–‹å§‹";
                nextBtn.onclick = () => location.reload();
                timerBtn.disabled = true;
                return;
            }

            const q = gameQueue[currentIndex];
            questionDisplay.innerText = q.text;
            
            if (q.text.length > 8) questionDisplay.style.fontSize = "2.2rem";
            else if (q.text.length > 5) questionDisplay.style.fontSize = "2.5rem";
            else questionDisplay.style.fontSize = "3rem";

            progressText.innerText = `Quest ${currentIndex + 1}/${gameQueue.length}`;
            levelTag.innerText = `ç­‰ç´š: ${q.type}`;
        }

        // --- 3. è¨ˆæ™‚å™¨èˆ‡éŸ³æ•ˆ ---
        function toggleTimer() {
            if (timerInterval) {
                stopTimer();
                return; 
            }
            
            let timeLeft = timerDuration;
            timerDisplay.innerText = timeLeft;
            timerBtn.innerText = "â¹ï¸ åœæ­¢";
            
            timerInterval = setInterval(() => {
                timeLeft--;
                timerDisplay.innerText = timeLeft;

                if (timeLeft <= 5 && timeLeft > 0) {
                    timerDisplay.classList.add('timer-warning');
                    playBeep(440, 0.1); 
                } else if (timeLeft === 0) {
                    playBeep(880, 0.5); 
                    timerDisplay.innerText = "æ™‚é–“åˆ°ï¼";
                    stopTimer();
                    timerBtn.innerText = "â±ï¸ é–‹å§‹è¨ˆæ™‚";
                }
            }, 1000);
        }

        function stopTimer() {
            clearInterval(timerInterval);
            timerInterval = null;
            timerDisplay.classList.remove('timer-warning');
        }

        function playBeep(frequency, duration) {
            if (!audioContext) return;
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();

            oscillator.type = 'square'; 
            oscillator.frequency.value = frequency;
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);

            oscillator.start();
            gainNode.gain.exponentialRampToValueAtTime(0.00001, audioContext.currentTime + duration);
            oscillator.stop(audioContext.currentTime + duration);
        }

        // --- 4. BGM é–‹é—œæ§åˆ¶ ---
        function toggleBGMSetup() {
            isBGMOn = !isBGMOn;
            updateSwitchUI('setup-bgm-switch', isBGMOn);
            updateSwitchUI('game-bgm-switch', isBGMOn); 
        }

        function toggleBGMGame() {
            isBGMOn = !isBGMOn;
            updateSwitchUI('setup-bgm-switch', isBGMOn);
            updateSwitchUI('game-bgm-switch', isBGMOn);
            
            if (isBGMOn) bgmPlayer.play();
            else bgmPlayer.pause();
        }

        function updateSwitchUI(id, isOn) {
            const el = document.getElementById(id).querySelector('.toggle-box');
            if (isOn) el.classList.add('active');
            else el.classList.remove('active');
        }

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

    </script>
</body>
</html>