<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ä½ ç•«æˆ‘çŒœæˆèªç‰ˆ - é¡Œç›®ç”¢ç”Ÿå™¨</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@700;900&display=swap" rel="stylesheet">
    
    <script src="questions.js"></script>

    <style>
        :root {
            --main-bg: radial-gradient(circle at center, #2b32b2, #141e30);
            --box-bg: #fff;
            --text-color: #333;
            --highlight-orange: #ff6600;
            --highlight-yellow: #ffcc00;
            --highlight-blue: #0044cc;
            --highlight-green: #00cc66;
            --danger: #cc0000;
            --hint-color: #7f8c8d;
        }

        * { box-sizing: border-box; user-select: none; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: 'Noto Sans TC', sans-serif;
            background: var(--main-bg);
            background-size: 100% 100%;
            color: var(--text-color);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            min-height: 100vh; margin: 0; padding: 15px; overflow-x: hidden;
        }

        .variety-box {
            background: var(--box-bg); 
            border-radius: 20px;
            border: 5px solid var(--highlight-blue);
            box-shadow: 0 0 0 5px #fff inset, 0 10px 30px rgba(0,0,0,0.5), 0 0 20px var(--highlight-orange);
            padding: 25px; 
            position: relative; margin-bottom: 20px;
            width: 100%; max-width: 650px;
            text-align: center; 
        }

        h1 {
            color: var(--highlight-blue); font-weight: 900; font-size: 2.5rem; margin-top: 0;
            text-shadow: 3px 3px 0 #fff, 5px 5px 0 var(--highlight-yellow); letter-spacing: 2px;
        }

        .setting-group { margin-bottom: 20px; font-size: 1.3rem; font-weight: 900; color: var(--highlight-orange); text-align: left; padding: 0 20px; }
        
        .remain-hint { font-size: 0.9rem; color: var(--hint-color); font-weight: 500; margin-top: 5px; display: block; }

        input[type="number"] { 
            width: 100%; border: 4px solid var(--highlight-blue); border-radius: 15px; padding: 10px; font-size: 1.5rem; font-weight: 900; text-align: center; color: var(--highlight-blue); background: #f0f8ff;
        }

        .btn {
            background: linear-gradient(to bottom, var(--highlight-yellow), var(--highlight-orange)); 
            color: #fff; border: none; border-radius: 50px; padding: 15px 30px; 
            font-size: 1.6rem; font-weight: 900; cursor: pointer; width: 100%; margin-top: 15px;
            box-shadow: 0 6px 0 #cc5200, 0 10px 20px rgba(0,0,0,0.4); 
            text-shadow: 1px 1px 2px rgba(0,0,0,0.3); transition: all 0.1s;
        }
        .btn:active { transform: translateY(4px); box-shadow: 0 2px 0 #cc5200; }
        .btn:disabled { background: #bdc3c7; box-shadow: none; color: #7f8c8d; cursor: not-allowed; transform: none; }

        .btn-quit {
            background: transparent;
            color: #95a5a6;
            border: none; box-shadow: none;
            font-size: 0.9rem; font-weight: normal;
            padding: 10px; margin-top: 30px;
            text-decoration: underline; width: auto;
            cursor: pointer; opacity: 0.6; transition: all 0.3s;
        }
        .btn-quit:hover { color: var(--danger); opacity: 1; }

        #game-screen { display: none; }

        .status-bar {
            display: flex; justify-content: space-between; margin-bottom: 15px; 
            font-size: 1.2rem; font-weight: 900; color: #fff; background: var(--highlight-blue); 
            padding: 8px 20px; border-radius: 50px; box-shadow: 0 4px 0 rgba(0,0,0,0.2);
        }

        #question-display {
            font-size: 5rem; font-weight: 900; min-height: 250px;
            display: flex; align-items: center; justify-content: center;
            color: var(--highlight-blue); background: #fffbe6;
            border: 4px dashed var(--highlight-orange); border-radius: 20px; margin: 15px 0; padding: 10px;
            word-break: keep-all;
        }

        .timer-box { 
            font-size: 3rem; font-weight: 900; margin: 10px auto; padding: 5px 30px; 
            background: #fff; border: 4px solid var(--highlight-blue); border-radius: 50px; color: var(--highlight-blue); 
            display: inline-block; 
        }
        .timer-warning { color: var(--danger); border-color: var(--danger); background: #fff0f0; animation: pulse 0.5s infinite alternate; }
        @keyframes pulse { from { transform: scale(1); } to { transform: scale(1.05); } }

        .switch-container { display: inline-flex; align-items: center; justify-content: center; margin-top: 20px; font-size: 1rem; font-weight: 900; color: #fff; cursor: pointer; background: rgba(0,0,0,0.3); padding: 8px 20px; border-radius: 30px; }
        .toggle-box { width: 24px; height: 24px; background: #fff; border: 3px solid var(--highlight-orange); border-radius: 50%; margin-right: 10px; display: flex; align-items: center; justify-content: center; }
        .toggle-check { width: 14px; height: 14px; background: var(--highlight-orange); border-radius: 50%; display: none; }
        .active .toggle-check { display: block; }

        .reload-link { margin-top: 25px; font-size: 1rem; color: #aaa; cursor:pointer; text-decoration: underline; font-weight: 700; padding: 10px; }

        #guide-btn { position: fixed; top: 15px; right: 15px; z-index: 1000; background: var(--highlight-green); color: #fff; border: none; border-radius: 30px; padding: 10px 20px; font-weight: 900; cursor: pointer; box-shadow: 0 4px 0 #008f47; }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 2000; display: none; align-items: center; justify-content: center; padding: 20px; }
        .modal-box { background: #fff; border: 5px solid var(--highlight-blue); border-radius: 30px; padding: 25px; width: 100%; max-width: 500px; max-height: 85vh; overflow-y: auto; }
        .modal-title { color: var(--highlight-blue); text-align: center; font-size: 1.8rem; font-weight: 900; margin-bottom: 20px; border-bottom: 3px dashed var(--highlight-orange); padding-bottom: 10px; }
        .guide-section { margin-bottom: 15px; line-height: 1.6; font-size: 1.1rem; color: #333; }
        .guide-section strong { color: var(--highlight-orange); }

        @media (max-width: 600px) {
            .variety-box { padding: 20px 15px; } h1 { font-size: 2rem; }
            #question-display { min-height: 200px; font-size: 3.5rem; } .btn { font-size: 1.4rem; padding: 12px; }
        }
    </style>
</head>
<body>

    <audio id="bgm-player" loop><source src="bg-music.mp3" type="audio/mpeg"></audio>

    <button id="guide-btn" onclick="openGuide()">ğŸ“œ è¦å‰‡èªªæ˜</button>

    <div id="guide-modal" class="modal-overlay" onclick="closeGuide(event)">
        <div class="modal-box" onclick="event.stopPropagation()">
            <div class="modal-title">ğŸ¨ ä½ ç•«æˆ‘çŒœæˆèªç‰ˆ</div>
            <div class="guide-section"><strong>1. è¨­å®šé—œå¡</strong><br>ã€ŒåŸºç¤é¡Œã€å¤šç‚ºå…·è±¡æˆèªï¼›ã€Œé€²éšé¡Œã€ç‚ºæŠ½è±¡æŒ‘æˆ°ã€‚</div>
            <div class="guide-section"><strong>ğŸŒŸ 2. æ™ºæ…§è¨˜æ†¶</strong><br>ç³»çµ±æœƒè‡ªå‹•é¡¯ç¤ºé‚„å‰©å¤šå°‘é¡Œæ²’ç©éï¼Œä¸¦éæ¿¾å·²ç©é¡Œç›®ã€‚</div>
            <div class="guide-section"><strong>3. æ“ä½œå¯†æŠ€</strong><br>ä¸Šä¸‹éµå¢æ¸› 10 ç§’ã€‚å¯éš¨æ™‚æŒ‰ã€Œæ”¾æ£„ã€å›è¨­å®šé ã€‚</div>
            <div class="guide-section"><strong>4. æ¸…é™¤ç´€éŒ„</strong><br>è‹¥é¡Œç›®ç©å®Œäº†ï¼Œè«‹é»æ“Šä¸‹æ–¹ã€Œæ¸…é™¤ç´€éŒ„ã€ã€‚</div>
            <button class="btn close-btn" onclick="closeGuide(null)" style="margin-top:20px;">é–‹å§‹éŠæˆ²ï¼</button>
        </div>
    </div>

    <div id="setup-screen" class="variety-box">
        <h1>ğŸ¨ ä½ ç•«æˆ‘çŒœæˆèªç‰ˆ</h1>
        
        <div class="setting-group">
            <label>åŸºç¤é¡Œæ•¸ (ç°¡å–®/å…·è±¡):</label>
            <input type="number" id="basic-count" value="3" min="0">
            <span id="basic-remain" class="remain-hint">è¼‰å…¥ä¸­...</span>
        </div>

        <div class="setting-group">
            <label>é€²éšé¡Œæ•¸ (æŠ½è±¡/å›°é›£):</label>
            <input type="number" id="adv-count" value="2" min="0">
            <span id="adv-remain" class="remain-hint">è¼‰å…¥ä¸­...</span>
        </div>

        <div class="setting-group">
            <label>å€’æ•¸æ™‚é–“ (ç§’):</label>
            <input type="number" id="timer-set" value="20" min="10" step="10">
        </div>

        <div class="switch-container" onclick="toggleBGMSetup()" id="setup-bgm-switch">
            <div class="toggle-box active"><div class="toggle-check"></div></div>
            <span>èƒŒæ™¯éŸ³æ¨‚ (BGM)</span>
        </div>

        <button class="btn" onclick="startGame()">ğŸ”¥ é–‹å§‹æŒ‘æˆ°ï¼ ğŸ”¥</button>
        
        <div class="reload-link" onclick="resetHistory()">
            ğŸ—‘ï¸ æ¸…é™¤å·²ç©ç´€éŒ„ (é‡ç½®é¡Œåº«)
        </div>
    </div>

    <div id="game-screen" class="variety-box">
        <div class="status-bar">
            <span id="progress-text">ç¬¬ 1/15 é¡Œ</span>
            <span id="level-tag" style="color:#fff;">ã€åŸºç¤é¡Œã€‘</span>
        </div>

        <div id="question-display">æº–å‚™ä¸­...</div>
        <div class="timer-box" id="timer-display">--</div>

        <button class="btn" id="timer-btn" onclick="toggleTimer()" style="background: linear-gradient(to bottom, #00cc66, #008f47); box-shadow: 0 6px 0 #005c2e;">â±ï¸ é–‹å§‹è¨ˆæ™‚</button>
        <button class="btn" id="next-btn" onclick="nextQuestion()">ğŸ‘‰ ä¸‹ä¸€é¡Œ</button>
        
        <div style="margin-top: 15px;">
            <div class="switch-container" onclick="toggleBGMGame()" id="game-bgm-switch">
                <div class="toggle-box active"><div class="toggle-check"></div></div>
                <span>BGM é–‹é—œ</span>
            </div>
        </div>

        <button class="btn-quit" onclick="confirmQuit()">[ æ”¾æ£„æœ¬å±€ / å›åˆ°è¨­å®šé  ]</button>
    </div>

    <script>
        // --- éŠæˆ²ç‹€æ…‹ ---
        let gameQueue = [];
        let currentIndex = -1;
        let timerDuration = 60;
        let timerInterval = null;
        let isBGMOn = true;
        let audioContext = null;
        let playedHistory = JSON.parse(localStorage.getItem('playedIdiomsHistory')) || [];

        // --- DOM ---
        const setupScreen = document.getElementById('setup-screen');
        const gameScreen = document.getElementById('game-screen');
        const bgmPlayer = document.getElementById('bgm-player');
        const questionDisplay = document.getElementById('question-display');
        const progressText = document.getElementById('progress-text');
        const levelTag = document.getElementById('level-tag');
        const timerDisplay = document.getElementById('timer-display');
        const timerBtn = document.getElementById('timer-btn');
        const nextBtn = document.getElementById('next-btn');
        const guideModal = document.getElementById('guide-modal');
        const basicRemainLabel = document.getElementById('basic-remain');
        const advRemainLabel = document.getElementById('adv-remain');

        // --- æª¢æŸ¥é¡Œåº«æª”æ¡ˆæ˜¯å¦è¼‰å…¥ ---
        if (typeof db_basic === 'undefined' || typeof db_advanced === 'undefined') {
            alert("âš ï¸ éŒ¯èª¤ï¼šæ‰¾ä¸åˆ°é¡Œåº«æª”æ¡ˆ questions.jsï¼\nè«‹ç¢ºèª index.html èˆ‡ questions.js æ”¾åœ¨åŒä¸€å€‹è³‡æ–™å¤¾å…§ã€‚");
        }

        function updateRemainCounts() {
            if (typeof db_basic === 'undefined') return;
            const availableBasic = db_basic.filter(q => !playedHistory.includes(q));
            const availableAdv = db_advanced.filter(q => !playedHistory.includes(q));
            basicRemainLabel.innerText = `(é¡Œåº«å°šæœ‰ ${availableBasic.length} é¡Œæœªç©é)`;
            advRemainLabel.innerText = `(é¡Œåº«å°šæœ‰ ${availableAdv.length} é¡Œæœªç©é)`;
        }
        updateRemainCounts();

        function openGuide() { guideModal.style.display = 'flex'; }
        function closeGuide(event) { if (event === null || event.target === guideModal) guideModal.style.display = 'none'; }

        // --- 1. é–‹å§‹éŠæˆ² ---
        function startGame() {
            const basicCount = parseInt(document.getElementById('basic-count').value) || 0;
            const advCount = parseInt(document.getElementById('adv-count').value) || 0;
            timerDuration = parseInt(document.getElementById('timer-set').value) || 20;

            if (basicCount + advCount === 0) { alert("è«‹è‡³å°‘è¨­å®šä¸€é¡Œï¼"); return; }

            const availableBasic = db_basic.filter(q => !playedHistory.includes(q));
            const availableAdv = db_advanced.filter(q => !playedHistory.includes(q));

            if (basicCount > availableBasic.length || advCount > availableAdv.length) {
                alert(`é¡Œåº«å­˜é‡ä¸è¶³ï¼\n\nåŸºç¤é¡Œå‰©: ${availableBasic.length}\né€²éšé¡Œå‰©: ${availableAdv.length}\n\nè«‹æ¸›å°‘è¨­å®šæ•¸é‡ã€‚`);
                return;
            }

            const finalBasic = shuffleArray([...availableBasic]).slice(0, basicCount).map(t => ({text: t, type: 'åŸºç¤é¡Œ', color: 'var(--highlight-blue)'}));
            const finalAdv = shuffleArray([...availableAdv]).slice(0, advCount).map(t => ({text: t, type: 'é€²éšé¡Œ', color: 'var(--danger)'}));
            
            gameQueue = [...finalBasic, ...finalAdv];

            if (!audioContext) audioContext = new (window.AudioContext || window.webkitAudioContext)();
            setupScreen.style.display = 'none';
            gameScreen.style.display = 'block';
            if (isBGMOn) { bgmPlayer.volume = 0.5; bgmPlayer.play().catch(e => console.log("BGM Blocked")); }

            nextQuestion();
        }

        // --- 2. é¡Œç›®æ§åˆ¶ ---
        function nextQuestion() {
            stopTimer();
            timerDisplay.innerText = timerDuration;
            timerDisplay.classList.remove('timer-warning');
            timerBtn.innerText = "â±ï¸ é–‹å§‹è¨ˆæ™‚";
            timerBtn.disabled = false;

            currentIndex++;

            if (currentIndex >= gameQueue.length) {
                questionDisplay.innerHTML = "<span style='font-size: 3rem; color:var(--highlight-orange)'>ğŸ‰ æŒ‘æˆ°çµæŸï¼ğŸ‰</span>";
                progressText.innerText = "END"; levelTag.innerText = "";
                nextBtn.innerText = "ğŸ”„ è¨­å®šæ–°ä¸€è¼ª";
                nextBtn.onclick = () => location.reload();
                timerBtn.disabled = true;
                return;
            }

            const q = gameQueue[currentIndex];
            questionDisplay.innerText = q.text;

            playedHistory.push(q.text);
            localStorage.setItem('playedIdiomsHistory', JSON.stringify(playedHistory));
            
            const isMobile = window.innerWidth < 600;
            if (q.text.length > 5) {
                questionDisplay.style.fontSize = isMobile ? "3rem" : "4.5rem";
            } else {
                questionDisplay.style.fontSize = isMobile ? "4rem" : "6rem";
            }

            progressText.innerText = `ç¬¬ ${currentIndex + 1}/${gameQueue.length} é¡Œ`;
            levelTag.innerText = `ã€${q.type}ã€‘`;
            levelTag.style.backgroundColor = q.color === 'var(--danger)' ? 'var(--danger)' : 'var(--highlight-blue)';
        }

        // --- 3. è¨ˆæ™‚å™¨èˆ‡éŸ³æ•ˆ (å¼·åŒ–ç‰ˆ) ---
        function toggleTimer() {
            if (timerInterval) { stopTimer(); return; }
            let timeLeft = timerDuration;
            timerDisplay.innerText = timeLeft;
            timerBtn.innerText = "â¹ï¸ åœæ­¢è¨ˆæ™‚";
            
            timerInterval = setInterval(() => {
                timeLeft--;
                timerDisplay.innerText = timeLeft;

                if (timeLeft <= 5 && timeLeft > 0) {
                    timerDisplay.classList.add('timer-warning');
                    // â˜… è²éŸ³ä¿®æ”¹ï¼šé »ç‡éš¨æ™‚é–“å‡é«˜ (880Hz -> 1080Hz)ï¼Œä½¿ç”¨æ–¹å½¢æ³¢ï¼ŒéŸ³é‡åŠ å¤§
                    let pitch = 880 + (5 - timeLeft) * 50; 
                    playBeep(pitch, 0.15, 'square', 0.5); 
                } else if (timeLeft === 0) {
                    // â˜… è²éŸ³ä¿®æ”¹ï¼šä½éŸ³é‹¸é½’æ³¢ (Buzzer)ï¼ŒéŸ³é‡æœ€å¤§ï¼ŒæŒçºŒ 1.5 ç§’
                    playBeep(200, 1.5, 'sawtooth', 1.0); 
                    timerDisplay.innerText = "æ™‚é–“åˆ°ï¼âŒ";
                    stopTimer();
                    timerBtn.innerText = "â±ï¸ é–‹å§‹è¨ˆæ™‚";
                    timerBtn.disabled = true;
                }
            }, 1000);
        }

        function stopTimer() { clearInterval(timerInterval); timerInterval = null; timerDisplay.classList.remove('timer-warning'); }

        // â˜… éŸ³æ•ˆç”¢ç”Ÿå™¨æ ¸å¿ƒ (æ–°å¢ type å’Œ vol åƒæ•¸)
        function playBeep(frequency, duration, type = 'sine', volume = 1.0) {
            if (!audioContext) return;
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();

            oscillator.type = type; // square, sawtooth, triangle, sine
            oscillator.frequency.value = frequency;

            // è¨­å®šéŸ³é‡
            gainNode.gain.setValueAtTime(volume, audioContext.currentTime);
            // ç¨å¾®æ·¡å‡ºé¿å…çˆ†éŸ³
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + duration);

            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);

            oscillator.start();
            oscillator.stop(audioContext.currentTime + duration);
        }

        function toggleBGMSetup() { isBGMOn = !isBGMOn; updateSwitchUI('setup-bgm-switch', isBGMOn); updateSwitchUI('game-bgm-switch', isBGMOn); }
        function toggleBGMGame() { isBGMOn = !isBGMOn; updateSwitchUI('setup-bgm-switch', isBGMOn); updateSwitchUI('game-bgm-switch', isBGMOn); if (isBGMOn) bgmPlayer.play(); else bgmPlayer.pause(); }
        function updateSwitchUI(id, isOn) { const el = document.getElementById(id).querySelector('.toggle-box'); if (isOn) el.classList.add('active'); else el.classList.remove('active'); }
        function shuffleArray(array) { for (let i = array.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [array[i], array[j]] = [array[j], array[i]]; } return array; }

        function resetHistory() {
            if (confirm("ã€è­¦å‘Šã€‘\nç¢ºå®šè¦æ¸…é™¤ç´€éŒ„å—ï¼Ÿ\næ¸…é™¤å¾Œï¼Œæˆèªå°‡æœƒé‡æ–°é‡è¤‡å‡ºç¾ã€‚")) {
                localStorage.removeItem('playedIdiomsHistory');
                alert("ç´€éŒ„å·²æ¸…é™¤ï¼");
                location.reload();
            }
        }

        function confirmQuit() {
            if (confirm("éŠæˆ²æ­£åœ¨é€²è¡Œä¸­ï¼Œç¢ºå®šè¦æ”¾æ£„ä¸¦å›åˆ°è¨­å®šé å—ï¼Ÿ")) {
                location.reload();
            }
        }
    </script>
</body>
</html>