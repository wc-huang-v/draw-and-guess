<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ç¶œè—å¤§æŒ‘æˆ° - é¡Œç›®ç”¢ç”Ÿå™¨</title>
    <link href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@500;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --main-bg: linear-gradient(135deg, #ff00cc, #3333ff);
            --box-bg: rgba(255, 255, 255, 0.95);
            --text-color: #333;
            --highlight-pink: #ff0099;
            --highlight-yellow: #ffcc00;
            --highlight-blue: #0066ff;
            --danger: #ff3300;
        }

        * { box-sizing: border-box; user-select: none; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: 'M PLUS Rounded 1c', sans-serif;
            background: var(--main-bg);
            background-image: radial-gradient(circle at 20% 20%, rgba(255,255,255,0.2) 0%, transparent 20%), radial-gradient(circle at 80% 80%, rgba(255,255,255,0.2) 0%, transparent 20%);
            background-size: 100% 100%;
            color: var(--text-color);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            min-height: 100vh; margin: 0; padding: 15px; overflow-x: hidden;
        }

        .variety-box {
            background: var(--box-bg); border-radius: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3), 0 0 0 5px #fff, 0 0 0 10px var(--highlight-pink), 0 0 20px var(--highlight-pink);
            padding: 25px; position: relative; margin-bottom: 20px;
            width: 100%; max-width: 650px; /* ç¨å¾®åŠ å¤§å¯¬åº¦çµ¦å¤§å­—é«” */
            text-align: center; border: 3px solid var(--highlight-blue);
        }

        h1 {
            color: var(--highlight-blue); font-weight: 800; font-size: 2.2rem; margin-top: 0;
            text-shadow: 2px 2px 0 #fff, 4px 4px 0 var(--highlight-pink); letter-spacing: 1px;
        }

        .setting-group { margin-bottom: 15px; font-size: 1.2rem; font-weight: 800; color: var(--highlight-pink); }
        input[type="number"] { width: 100%; border: 3px solid var(--highlight-yellow); border-radius: 15px; padding: 12px; font-size: 1.4rem; font-weight: 800; text-align: center; }

        .btn {
            background: linear-gradient(to bottom, var(--highlight-yellow), #ffaa00); color: #fff; border: none; border-radius: 50px; padding: 15px 30px; font-size: 1.5rem; font-weight: 800; cursor: pointer; width: 100%; margin-top: 15px;
            box-shadow: 0 5px 0 #cc8800, 0 8px 15px rgba(0,0,0,0.3), inset 0 -2px 5px rgba(0,0,0,0.2); text-shadow: 1px 1px 2px rgba(0,0,0,0.5); transition: all 0.1s;
        }
        .btn:active { transform: translateY(4px); box-shadow: 0 1px 0 #cc8800, inset 0 2px 5px rgba(0,0,0,0.2); }
        .btn:disabled { background: #ccc; box-shadow: none; color: #666; cursor: not-allowed; transform: none; }

        #game-screen { display: none; }

        .status-bar {
            display: flex; justify-content: space-between; margin-bottom: 15px; font-size: 1.1rem; font-weight: 800; color: var(--highlight-blue); background: rgba(255,255,255,0.8); padding: 5px 15px; border-radius: 20px;
        }

        /* --- é¡Œç›®é¡¯ç¤ºå€åŸŸ (åŠ å¤§ç‰ˆ) --- */
        #question-display {
            /* é è¨­è¶…å¤§å­—é«” */
            font-size: 5rem;
            font-weight: 800;
            min-height: 250px; /* å¢åŠ é«˜åº¦å®¹ç´å¤§å­— */
            display: flex; align-items: center; justify-content: center;
            color: #fff;
            -webkit-text-stroke: 3px var(--highlight-blue); /* åŠ ç²—æé‚Š */
            text-shadow: 4px 4px 0 var(--highlight-pink), 8px 8px 0 var(--highlight-yellow);
            line-height: 1.1;
            background: rgba(0,0,0,0.05);
            border-radius: 20px; margin: 15px 0; padding: 10px;
            word-break: keep-all; /* é˜²æ­¢å–®å­—ä¸­é–“æ›è¡Œ */
        }

        .timer-box { font-size: 2.5rem; font-weight: 800; margin: 15px auto; padding: 10px 30px; background: #fff; border: 4px solid var(--highlight-blue); border-radius: 50px; color: var(--highlight-blue); display: inline-block; }
        .timer-warning { color: var(--danger); border-color: var(--danger); background: #fff0f0; animation: pulse 0.5s infinite alternate; }
        @keyframes pulse { from { transform: scale(1); } to { transform: scale(1.05); } }

        .switch-container { display: inline-flex; align-items: center; justify-content: center; margin-top: 20px; font-size: 1rem; font-weight: 800; color: var(--highlight-pink); cursor: pointer; background: rgba(255,255,255,0.6); padding: 5px 15px; border-radius: 30px; }
        .toggle-box { width: 24px; height: 24px; background: #fff; border: 3px solid var(--highlight-pink); border-radius: 50%; margin-right: 10px; display: flex; align-items: center; justify-content: center; }
        .toggle-check { width: 14px; height: 14px; background: var(--highlight-pink); border-radius: 50%; display: none; }
        .active .toggle-check { display: block; }

        .reload-link { margin-top: 25px; font-size: 1rem; color: var(--danger); cursor:pointer; text-decoration: underline; font-weight: 800; padding: 10px; background: rgba(255,255,255,0.5); border-radius: 10px;}

        #guide-btn { position: fixed; top: 15px; right: 15px; z-index: 1000; background: var(--highlight-blue); color: #fff; border: none; border-radius: 30px; padding: 10px 20px; font-weight: 800; cursor: pointer; box-shadow: 0 4px 0 #0044cc; }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 2000; display: none; align-items: center; justify-content: center; padding: 20px; }
        .modal-box { background: #fff; border: 5px solid var(--highlight-pink); border-radius: 30px; padding: 25px; width: 100%; max-width: 500px; max-height: 85vh; overflow-y: auto; }
        .modal-title { color: var(--highlight-pink); text-align: center; font-size: 1.8rem; font-weight: 800; margin-bottom: 20px; border-bottom: 3px dashed var(--highlight-yellow); padding-bottom: 10px; }
        .guide-section { margin-bottom: 15px; line-height: 1.5; font-size: 1.1rem; }
        .guide-section strong { color: var(--highlight-blue); }

        /* --- RWD éŸ¿æ‡‰å¼èª¿æ•´ (é‡å°æ‰‹æ©Ÿå¹³æ¿) --- */
        @media (max-width: 600px) {
            .variety-box { padding: 20px 15px; }
            h1 { font-size: 1.8rem; }
            /* æ‰‹æ©Ÿç‰ˆå­—é«”ç¨å¾®ç¸®å°ä¸€é»é»ï¼Œä»¥å…æ’ç ´ç•«é¢ï¼Œä½†é‚„æ˜¯å¾ˆå¤§ */
            #question-display { min-height: 200px; font-size: 3.5rem; -webkit-text-stroke: 2px var(--highlight-blue); }
            .btn { font-size: 1.3rem; padding: 12px; }
            .timer-box { font-size: 2rem; padding: 8px 25px; }
        }
    </style>
</head>
<body>

    <audio id="bgm-player" loop><source src="bg-music.mp3" type="audio/mpeg"></audio>

    <button id="guide-btn" onclick="openGuide()">ğŸ“œ éŠæˆ²è¦å‰‡</button>

    <div id="guide-modal" class="modal-overlay" onclick="closeGuide(event)">
        <div class="modal-box" onclick="event.stopPropagation()">
            <div class="modal-title">ğŸ”¥ ç¶œè—å¤§æŒ‘æˆ°è¦å‰‡ ğŸ”¥</div>
            <div class="guide-section">
                <strong>1. è¨­å®šé—œå¡ (å…ˆåŸºç¤å¾Œé€²éš)</strong><br>è¼¸å…¥é¡Œç›®æ•¸é‡ï¼ŒæŒ‘æˆ°æœƒä¾åºé€²è¡Œã€‚
            </div>
            <div class="guide-section">
                <strong>ğŸŒŸ 2. åŒè£ç½®ä¸é‡è¤‡å‡ºé¡Œ</strong><br>ç³»çµ±æœƒè¨˜ä½é€™å°æ‰‹æ©Ÿ/é›»è…¦ç©éçš„é¡Œç›®ã€‚é‡æ–°æ•´ç†æˆ–ä¸‹æ¬¡å†é–‹ï¼Œéƒ½ä¸æœƒå‡ºç¾é‡è¤‡çš„ï¼ç›´åˆ°é¡Œç›®ç”¨å…‰ç‚ºæ­¢ã€‚
            </div>
            <div class="guide-section">
                <strong>3. é™æ™‚æŒ‘æˆ°</strong><br>æœ€å¾Œ 5 ç§’æœ‰ç·Šå¼µéŸ³æ•ˆæç¤ºï¼Œæ™‚é–“åˆ°å°±è¼¸äº†ï¼
            </div>
            <div class="guide-section">
                <strong>4. æ¸…é™¤ç´€éŒ„</strong><br>è‹¥è¦å¾¹åº•é‡ç½®é¡Œåº«ï¼Œè«‹é»æ“Šç•«é¢æœ€ä¸‹æ–¹çš„ç´…è‰²ã€Œæ¸…é™¤æ‰€æœ‰éŠç©ç´€éŒ„ã€ã€‚
            </div>
            <button class="btn close-btn" onclick="closeGuide(null)" style="margin-top:20px;">æˆ‘çŸ¥é“äº†ï¼</button>
        </div>
    </div>

    <div id="setup-screen" class="variety-box">
        <h1>ğŸš€ ç¶œè—å¤§æŒ‘æˆ°è¨­å®š</h1>
        
        <div class="setting-group">
            <label>åŸºç¤é¡Œæ•¸é‡ (å…ˆå‡º):</label>
            <input type="number" id="basic-count" value="10" min="0">
        </div>

        <div class="setting-group">
            <label>é€²éšé¡Œæ•¸é‡ (å¾Œå‡º):</label>
            <input type="number" id="adv-count" value="5" min="0">
        </div>

        <div class="setting-group">
            <label>å€’æ•¸æ™‚é–“ (ç§’):</label>
            <input type="number" id="timer-set" value="60" min="10">
        </div>

        <div class="switch-container" onclick="toggleBGMSetup()" id="setup-bgm-switch">
            <div class="toggle-box active"><div class="toggle-check"></div></div>
            <span>èƒŒæ™¯éŸ³æ¨‚ (BGM)</span>
        </div>

        <button class="btn" onclick="startGame()">ğŸ”¥ é–‹å§‹æŒ‘æˆ°ï¼ ğŸ”¥</button>
        
        <div class="reload-link" onclick="resetHistory()">
            ğŸ—‘ï¸ æ¸…é™¤æ‰€æœ‰éŠç©ç´€éŒ„ (é‡ç½®é¡Œåº«)
        </div>
    </div>

    <div id="game-screen" class="variety-box">
        <div class="status-bar">
            <span id="progress-text">ç¬¬ 1/15 é¡Œ</span>
            <span id="level-tag" style="color:var(--highlight-pink);">ã€åŸºç¤é¡Œã€‘</span>
        </div>

        <div id="question-display">æº–å‚™ä¸­...</div>

        <div class="timer-box" id="timer-display">--</div>

        <button class="btn" id="timer-btn" onclick="toggleTimer()" style="background: linear-gradient(to bottom, #ff3399, #cc0066); box-shadow: 0 5px 0 #99004d;">â±ï¸ é–‹å§‹è¨ˆæ™‚</button>
        <button class="btn" id="next-btn" onclick="nextQuestion()">ğŸ‘‰ ä¸‹ä¸€é¡ŒæŒ‘æˆ°</button>
        
        <div style="margin-top: 15px;">
            <div class="switch-container" onclick="toggleBGMGame()" id="game-bgm-switch">
                <div class="toggle-box active"><div class="toggle-check"></div></div>
                <span>BGM é–‹é—œ</span>
            </div>
        </div>
        
        <div class="reload-link" onclick="resetHistory()">
            ğŸ—‘ï¸ æ¸…é™¤æ‰€æœ‰éŠç©ç´€éŒ„ (é‡ç½®é¡Œåº«)
        </div>
    </div>

    <script>
        // --- é¡Œåº«è³‡æ–™ ---
        const db_basic = ["çç å¥¶èŒ¶", "è‡­è±†è…", "é¹¹é…¥é›", "å¤§è…¸åŒ…å°è…¸", "æ»·è‚‰é£¯", "é›æ’", "è±¬è¡€ç³•", "åœ°ç“œçƒ", "èšµä»”ç…", "å°ç± åŒ…", "ç‰›è‚‰éºµ", "èŠ’æœå†°", "æœ¨ç“œç‰›å¥¶", "æ—©é¤åº—å¥¶èŒ¶", "åƒåˆ°é£½", "è¿´è½‰å£½å¸", "è–‘æ¯é´¨", "ç¾Šè‚‰çˆ", "éº»è¾£é‹", "é¼æ³°è±", "éº¥ç•¶å‹", "è‚¯å¾·åŸº", "å¿…å‹å®¢", "ä¸¹ä¸¹æ¼¢å ¡", "æ°¸å’Œè±†æ¼¿", "ç†±ç‚’åº—", "æµæ°´å¸­", "è¾¦æ¡Œ", "é³³æ¢¨é…¥", "è»Šè¼ªé¤…", "è¿½åƒåœ¾è»Š", "é¨æ©Ÿè»Š", "æˆ´å®‰å…¨å¸½", "å…©æ®µå¼å·¦è½‰", "æ‰¾åœè»Šä½", "è¢«é–‹ç½°å–®", "æ‹–åŠè»Š", "å¡è»Š", "æ·é‹è®“åº§", "åšæ„›åº§", "æ‚ éŠå¡", "YouBike", "å¤¾å¨ƒå¨ƒæ©Ÿ", "ä¾¿åˆ©å•†åº—", "è«‹æ”¯æ´æ”¶éŠ€", "è¦çš®åº—åˆ°åº—", "çµ±ä¸€ç™¼ç¥¨", "ä¸­ç", "åˆ®åˆ®æ¨‚", "å¨åŠ›å½©", "å€’åƒåœ¾", "ç­‰ç´…ç¶ ç‡ˆ", "è¡Œäººåœ°ç„", "ä¸‰å¯¶", "é…’æ¸¬", "å«å¤–é€", "UberEats", "è–ªæ°´å°å·", "æ…£è€é—†", "è²¬ä»»åˆ¶", "åŠ ç­è²»", "çœ¼ç¥æ­»", "æƒ…ç·’å‹’ç´¢", "åª½å¯¶", "å…¬ä¸»ç—…", "æ¸£ç”·", "æšˆèˆ¹", "é‚Šç·£äºº", "ç¤¾ç•œ", "èººå¹³", "å¹´çµ‚çé‡‘", "å°¾ç‰™", "å±…å®¶è¾¦å…¬", "è¦–è¨Šæœƒè­°", "å·²è®€ä¸å›", "æŒ‰è®šåˆ†äº«", "ç¶²ç¾æ™¯é»", "ä¿®åœ–", "é¢±é¢¨å‡", "åœ°éœ‡", "åœé›»", "å»æ‹œæ‹œ", "æ”¶é©š", "æ“²ç­Š", "æ±‚ç±¤", "å®‰å¤ªæ­²", "æ¶é ­é¦™", "åŒ…ç´…åŒ…", "å–å–œé…’", "æ‰“éº»å°‡", "æ»‘æ‰‹æ©Ÿ", "è‡ªæ‹", "æŒ–é¼»å­”", "å‰ªæŒ‡ç”²", "åˆ·ç‰™æ´—è‡‰", "ä¸Šå»æ‰€æ²’ç´™", "æ´—æ¾¡å”±æ­Œ", "é‡é«”æº«", "åšå¿«ç¯©", "æ‰“ç–«è‹—", "æ’éšŠ", "æ’éšŠ", "æ‰“æ¶", "å ±è­¦", "å«æ•‘è­·è»Š", "çœ‹ç‰™é†«", "æ¸›è‚¥", "ä¼åœ°æŒºèº«", "ä»°è‡¥èµ·å", "æ·±è¹²"];
        const db_advanced = ["ç•«è›‡æ·»è¶³", "å°ç‰›å½ˆç´", "é›é£›ç‹—è·³", "ç‹å‡è™å¨", "äº•åº•ä¹‹è›™", "å®ˆæ ªå¾…å…”", "äº¡ç¾Šè£œç‰¢", "é¶´ç«‹é›ç¾¤", "ç›²äººæ‘¸è±¡", "é­šç›®æ··ç ", "æŒ‡é¹¿ç‚ºé¦¬", "ç‹¼ç‹½ç‚ºå¥¸", "ç‹—æ€¥è·³ç‰†", "æ®ºé›å„†çŒ´", "é¨è™é›£ä¸‹", "é©šå¼“ä¹‹é³¥", "å¦‚é­šå¾—æ°´", "é¾é£›é³³èˆ", "ç¬¨é³¥å…ˆé£›", "å¼•ç‹¼å…¥å®¤", "æ‰“è‰é©šè›‡", "èª¿è™é›¢å±±", "è‘‰å…¬å¥½é¾", "é›é³´ç‹—ç›œ", "é³³æ¯›éºŸè§’", "æ©è€³ç›œéˆ´", "æ‹”è‹—åŠ©é•·", "åˆ»èˆŸæ±‚åŠ", "è² èŠè«‹ç½ª", "ç­é–€å¼„æ–§", "è‰èˆ¹å€Ÿç®­", "æ‡¸æ¢åˆºè‚¡", "èé›èµ·èˆ", "é‘¿å£å·å…‰", "æ±æ–½æ•ˆé¡°", "é †æ‰‹ç‰½ç¾Š", "æŠ±é ­é¼ ç«„", "å¼µç‰™èˆçˆª", "æ‰‹èˆè¶³è¹ˆ", "æ“ çœ‰å¼„çœ¼", "æ€’é«®è¡å† ", "å‚é ­å–ªæ°£", "ç›®çªå£å‘†", "ä¸ƒç«…ç”Ÿç…™", "æ§è…¹å¤§ç¬‘", "å“­ç¬‘ä¸å¾—", "é¢ç´…è€³èµ¤", "å’¬ç‰™åˆ‡é½’", "æ„çœ‰è‹¦è‡‰", "çœ‰é–‹çœ¼ç¬‘", "éª¨ç˜¦å¦‚æŸ´", "å¤§è…¹ä¾¿ä¾¿", "é ­ç ´è¡€æµ", "å¿ƒå¦‚åˆ€å‰²", "æ±—å¦‚é›¨ä¸‹", "ç†±é‹èèŸ»", "å‘†è‹¥æœ¨é›", "å£è‹¥æ‡¸æ²³", "å¤§åƒä¸€é©š", "ä¸€ç®­é›™éµ°", "ç™¾æ­¥ç©¿æ¥Š", "æ¯å¼“è›‡å½±", "éµæ¨¹é–‹èŠ±", "é¡èŠ±æ°´æœˆ", "é–€å¯ç¾…é›€", "é«˜æ¨“å¤§å»ˆ", "è»Šæ°´é¦¬é¾", "æ°´æ»´çŸ³ç©¿", "æ›‡èŠ±ä¸€ç¾", "å‹¢å¦‚ç ´ç«¹", "ä¸€åˆ€å…©æ–·", "æ”¯é›¢ç ´ç¢", "è—•æ–·çµ²é€£", "éŒ¦ä¸Šæ·»èŠ±", "é›ªä¸­é€ç‚­", "ç«ä¸ŠåŠ æ²¹", "å¦‚å±¥è–„å†°", "æ³°å±±å£“é ‚", "ä¸€çŸ³äºŒé³¥", "ç•«é¤…å……é£¢", "æœ›æ¢…æ­¢æ¸´", "é£›è›¾æ’²ç«", "è³è‡‚æ“‹è»Š", "ç·£æœ¨æ±‚é­š", "ç”•ä¸­æ‰é±‰", "è‡ªæŠ•ç¾…ç¶²", "é‡‘èŸ¬è„«æ®¼", "é³©ä½”éµ²å·¢", "è€é¦¬è­˜é€”", "ä¸‰é ­å…­è‡‚", "ç•°æƒ³å¤©é–‹", "æƒ³å…¥éé", "å¿ƒä¸åœ¨ç„‰", "å†¥æ€è‹¦æƒ³", "çŒ¶è±«ä¸æ±º", "æå¿ƒåŠè†½", "å¿ƒèŠ±æ€’æ”¾", "æƒ±ç¾æˆæ€’", "å¹¸ç½æ¨‚ç¦", "æäººæ†‚å¤©", "å‰›æ„è‡ªç”¨", "å„ªæŸ”å¯¡æ–·", "è‡ªä½œå¤šæƒ…", "æç„¶å¤§æ‚Ÿ", "é­‚é£›é­„æ•£", "ä¸å¯æ€è­°", "è«åå…¶å¦™", "å–œå‡ºæœ›å¤–", "æ¨‚ä¸æ€èœ€", "æ­¸å¿ƒä¼¼ç®­", "é›åŒé´¨è¬›", "ç«Šç«Šç§èª", "å–‹å–‹ä¸ä¼‘", "å”‡æ§èˆŒåŠ", "ç”œè¨€èœœèª", "æ¬å¼„æ˜¯é", "çœ¾å£é‘ é‡‘", "éœ‡è€³æ¬²è¾", "é´‰é›€ç„¡è²", "ç•°å£åŒè²", "æ¨ä¸‰é˜»å››", "å‹¾å¿ƒæ–—è§’", "çˆ¾è™æˆ‘è©", "çœ¾å›è¦ªé›¢", "æ ¼æ ¼ä¸å…¥", "è‡ªç›¸çŸ›ç›¾", "é€²é€€å…©é›£", "æœ¬æœ«å€’ç½®", "é›ªä¸ŠåŠ éœœ", "çµ•è™•é€¢ç”Ÿ", "ä¸‰å€‹è‡­çš®åŒ ", "çè²“ç¢°ä¸Šæ­»è€—å­", "é›è›‹è£¡æŒ‘éª¨é ­", "è–‘æ˜¯è€çš„è¾£", "ç‹—å˜´åä¸å‡ºè±¡ç‰™", "ç™©è›¤èŸ†æƒ³åƒå¤©éµè‚‰", "æ­¤åœ°ç„¡éŠ€ä¸‰ç™¾å…©", "è³ äº†å¤«äººåˆæŠ˜å…µ", "ä¸è¦‹æ£ºæä¸æ‰æ·š", "åƒä¸åˆ°è‘¡è„èªªè‘¡è„é…¸", "ç•™å¾—é’å±±åœ¨ä¸æ€•æ²’æŸ´ç‡’", "ä¸€æœè¢«è›‡å’¬åå¹´æ€•è‰ç¹©", "å·é›ä¸è‘—è•æŠŠç±³", "äº•æ°´ä¸çŠ¯æ²³æ°´", "äº”åæ­¥ç¬‘ç™¾æ­¥", "æ‰“ç ´ç ‚é‹å•åˆ°åº•", "æƒ¡äººå…ˆå‘Šç‹€", "äººä¸å¯è²Œç›¸", "å…«å­—é‚„æ²’ä¸€æ’‡", "å¤©ä¸‹æ²’æœ‰ç™½åƒçš„åˆé¤"];

        // --- éŠæˆ²ç‹€æ…‹ & æœ¬åœ°å„²å­˜ ---
        let gameQueue = [];
        let currentIndex = -1;
        let timerDuration = 60;
        let timerInterval = null;
        let isBGMOn = true;
        let audioContext = null;
        // è®€å–å·²ç©éçš„é¡Œç›®ç´€éŒ„
        let playedHistory = JSON.parse(localStorage.getItem('playedQuestionsHistory')) || [];

        const setupScreen = document.getElementById('setup-screen');
        const gameScreen = document.getElementById('game-screen');
        const bgmPlayer = document.getElementById('bgm-player');
        const questionDisplay = document.getElementById('question-display');
        const progressText = document.getElementById('progress-text');
        const levelTag = document.getElementById('level-tag');
        const timerDisplay = document.getElementById('timer-display');
        const timerBtn = document.getElementById('timer-btn');
        const nextBtn = document.getElementById('next-btn');
        const guideModal = document.getElementById('guide-modal');

        function openGuide() { guideModal.style.display = 'flex'; }
        function closeGuide(event) { if (event === null || event.target === guideModal) guideModal.style.display = 'none'; }

        // --- 1. åˆå§‹åŒ–èˆ‡é–‹å§‹éŠæˆ² ---
        function startGame() {
            const basicCount = parseInt(document.getElementById('basic-count').value) || 0;
            const advCount = parseInt(document.getElementById('adv-count').value) || 0;
            timerDuration = parseInt(document.getElementById('timer-set').value) || 60;

            if (basicCount + advCount === 0) { alert("è«‹è‡³å°‘è¨­å®šä¸€é¡Œï¼"); return; }

            // ã€é—œéµä¿®æ”¹ã€‘éæ¿¾æ‰å·²ç¶“ç©éçš„é¡Œç›®
            const availableBasic = db_basic.filter(q => !playedHistory.includes(q));
            const availableAdv = db_advanced.filter(q => !playedHistory.includes(q));

            if (basicCount > availableBasic.length || advCount > availableAdv.length) {
                alert(`é¡Œåº«å­˜é‡ä¸è¶³ï¼(å·²è‡ªå‹•éæ¿¾æ‰ç©éçš„é¡Œç›®)\n\nåŸºç¤é¡Œå‰©é¤˜: ${availableBasic.length}\né€²éšé¡Œå‰©é¤˜: ${availableAdv.length}\n\nè«‹æ¸›å°‘è¨­å®šæ•¸é‡ï¼Œæˆ–æŒ‰ä¸‹æ–¹ç´…è‰²æŒ‰éˆ•æ¸…é™¤ç´€éŒ„ã€‚`);
                return;
            }

            const finalBasic = shuffleArray([...availableBasic]).slice(0, basicCount).map(t => ({text: t, type: 'åŸºç¤é¡Œ', color: 'var(--highlight-pink)'}));
            const finalAdv = shuffleArray([...availableAdv]).slice(0, advCount).map(t => ({text: t, type: 'é€²éšé¡Œ', color: 'var(--danger)'}));
            
            gameQueue = [...finalBasic, ...finalAdv];

            if (!audioContext) audioContext = new (window.AudioContext || window.webkitAudioContext)();
            setupScreen.style.display = 'none';
            gameScreen.style.display = 'block';
            if (isBGMOn) { bgmPlayer.volume = 0.5; bgmPlayer.play().catch(e => console.log("BGM Blocked")); }

            nextQuestion();
        }

        // --- 2. é¡Œç›®æ§åˆ¶ (å«å­—é«”RWDèª¿æ•´èˆ‡ç´€éŒ„å„²å­˜) ---
        function nextQuestion() {
            stopTimer();
            timerDisplay.innerText = timerDuration;
            timerDisplay.classList.remove('timer-warning');
            timerBtn.innerText = "â±ï¸ é–‹å§‹è¨ˆæ™‚";
            timerBtn.disabled = false;

            currentIndex++;

            if (currentIndex >= gameQueue.length) {
                questionDisplay.innerHTML = "<span style='color:var(--highlight-yellow); font-size: 3rem;'>ğŸ‰ æœ¬è¼ªæŒ‘æˆ°çµæŸï¼ğŸ‰</span>";
                progressText.innerText = "END"; levelTag.innerText = "";
                nextBtn.innerText = "ğŸ”„ è¨­å®šæ–°ä¸€è¼ª";
                nextBtn.onclick = () => location.reload();
                timerBtn.disabled = true;
                return;
            }

            const q = gameQueue[currentIndex];
            questionDisplay.innerText = q.text;

            // ã€é—œéµä¿®æ”¹ã€‘å°‡é¡Œç›®åŠ å…¥æ­·å²ç´€éŒ„ä¸¦å­˜åˆ° localStorage
            playedHistory.push(q.text);
            localStorage.setItem('playedQuestionsHistory', JSON.stringify(playedHistory));
            
            // ã€é—œéµä¿®æ”¹ã€‘RWD å­—é«”å¤§å°èª¿æ•´ (æ‰‹æ©Ÿç‰ˆèˆ‡é›»è…¦ç‰ˆä¸åŒ)
            const isMobile = window.innerWidth < 600;
            if (q.text.length > 8) {
                questionDisplay.style.fontSize = isMobile ? "2.8rem" : "4rem"; // å­—å¤šæ™‚ç¸®å°
            } else if (q.text.length > 5) {
                questionDisplay.style.fontSize = isMobile ? "3.5rem" : "5rem";
            } else {
                questionDisplay.style.fontSize = isMobile ? "4.5rem" : "6rem"; // å­—å°‘æ™‚è¶…å¤§
            }

            progressText.innerText = `ç¬¬ ${currentIndex + 1}/${gameQueue.length} é¡Œ`;
            levelTag.innerText = `ã€${q.type}ã€‘`;
            levelTag.style.color = q.color;
        }

        // --- 3. è¨ˆæ™‚å™¨èˆ‡éŸ³æ•ˆ ---
        function toggleTimer() {
            if (timerInterval) { stopTimer(); return; }
            let timeLeft = timerDuration;
            timerDisplay.innerText = timeLeft;
            timerBtn.innerText = "â¹ï¸ åœæ­¢è¨ˆæ™‚";
            timerInterval = setInterval(() => {
                timeLeft--;
                timerDisplay.innerText = timeLeft;
                if (timeLeft <= 5 && timeLeft > 0) {
                    timerDisplay.classList.add('timer-warning'); playBeep(600, 0.1);
                } else if (timeLeft === 0) {
                    playBeep(300, 0.8); timerDisplay.innerText = "æ™‚é–“åˆ°ï¼âŒ"; stopTimer(); timerBtn.innerText = "â±ï¸ é–‹å§‹è¨ˆæ™‚"; timerBtn.disabled = true;
                }
            }, 1000);
        }
        function stopTimer() { clearInterval(timerInterval); timerInterval = null; timerDisplay.classList.remove('timer-warning'); }
        function playBeep(f, d) { if (!audioContext) return; const o = audioContext.createOscillator(); const g = audioContext.createGain(); o.type = 'sine'; o.frequency.value = f; o.connect(g); g.connect(audioContext.destination); o.start(); g.gain.exponentialRampToValueAtTime(0.00001, audioContext.currentTime + d); o.stop(audioContext.currentTime + d); }

        // --- 4. å…¶ä»–åŠŸèƒ½ ---
        function toggleBGMSetup() { isBGMOn = !isBGMOn; updateSwitchUI('setup-bgm-switch', isBGMOn); updateSwitchUI('game-bgm-switch', isBGMOn); }
        function toggleBGMGame() { isBGMOn = !isBGMOn; updateSwitchUI('setup-bgm-switch', isBGMOn); updateSwitchUI('game-bgm-switch', isBGMOn); if (isBGMOn) bgmPlayer.play(); else bgmPlayer.pause(); }
        function updateSwitchUI(id, isOn) { const el = document.getElementById(id).querySelector('.toggle-box'); if (isOn) el.classList.add('active'); else el.classList.remove('active'); }
        function shuffleArray(array) { for (let i = array.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [array[i], array[j]] = [array[j], array[i]]; } return array; }

        // ã€é—œéµä¿®æ”¹ã€‘æ¸…é™¤æ­·å²ç´€éŒ„åŠŸèƒ½
        function resetHistory() {
            if (confirm("ã€è­¦å‘Šã€‘\nç¢ºå®šè¦æ¸…é™¤æ­¤è£ç½®çš„æ‰€æœ‰éŠç©ç´€éŒ„å—ï¼Ÿ\n\næ¸…é™¤å¾Œï¼Œé¡Œç›®å¯èƒ½æœƒé‡è¤‡å‡ºç¾ã€‚")) {
                localStorage.removeItem('playedQuestionsHistory');
                alert("ç´€éŒ„å·²æ¸…é™¤ï¼é¡Œåº«å·²é‡ç½®ã€‚");
                location.reload();
            }
        }
    </script>
</body>
</html>