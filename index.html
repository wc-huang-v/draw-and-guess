<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ä½ ç•«æˆ‘çŒœæˆèªç‰ˆ</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@500;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="questions.js"></script>

    <style>
        :root {
            --main-bg: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            --box-bg: #ffffff;
            --box-shadow: 0 10px 30px rgba(0,0,0,0.25);
            --text-main: #2c3e50;
            --text-sub: #636e72;
            --accent-color: #ff6b6b;
            --secondary-color: #48dbfb;
            --secondary-dark: #0abde3;
            --danger: #ff4757;
            --demo-color: #f1c40f; 
            --switch-on-color: #007bff; 
            --prep-color: #3498db; 
            --draw-color: #2ecc71; 
        }

        * { box-sizing: border-box; user-select: none; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: 'Noto Sans TC', sans-serif;
            background: var(--main-bg);
            color: var(--text-main);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            min-height: 100vh; margin: 0; padding: 15px; overflow-x: hidden;
        }

        .variety-box {
            background: var(--box-bg); 
            border-radius: 24px;
            box-shadow: var(--box-shadow);
            padding: 30px 25px; 
            position: relative;
            margin-bottom: 20px;
            width: 100%; max-width: 600px;
            text-align: center; 
            border: 1px solid rgba(255,255,255,0.1);
            overflow: hidden; /* ç·å¸¶éœ€è¦é€™å€‹ï¼Œæ‰€ä»¥æ°£æ³¡å¿…é ˆä¹–ä¹–å¾…åœ¨æ¡†å…§ */
        }

        h1 {
            color: var(--text-main); font-weight: 900; font-size: 2.2rem; 
            margin: 10px 0 25px 0; letter-spacing: 1px;
            display: flex; align-items: center; justify-content: center; gap: 15px;
            transition: margin-top 0.3s; 
        }
        h1 i { color: var(--accent-color); font-size: 1.8rem; }

        .top-btn-group { position: absolute; top: 20px; right: 20px; display: flex; gap: 10px; z-index: 100; }

        .circle-btn {
            background: #f1f2f6; color: #747d8c; border: none; border-radius: 50%;
            width: 40px; height: 40px; font-size: 1.2rem; cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            transition: all 0.2s; box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .circle-btn:hover { background: var(--secondary-dark); color: #fff; transform: scale(1.1); }
        
        #demo-btn { color: #f39c12; }
        #demo-btn:hover { background: #f39c12; color: #fff; }

        /* è©¦ç©æ¨¡å¼æ¨™ç±¤ */
        .demo-ribbon {
            position: absolute; top: 35px; left: -45px; width: 180px;
            background: #ffeb3b; color: #d32f2f; font-weight: 900;
            font-size: 1.2rem; text-align: center; line-height: 40px;
            transform: rotate(-45deg); box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            z-index: 200; display: none; pointer-events: none;
            border: 3px solid #fff; animation: ribbon-pulse 2s infinite ease-in-out;
        }
        @keyframes ribbon-pulse {
            0% { transform: rotate(-45deg) scale(1); }
            50% { transform: rotate(-45deg) scale(1.05); } 
            100% { transform: rotate(-45deg) scale(1); }
        }

        .setting-group { margin-bottom: 20px; text-align: left; padding: 0 10px; }
        .setting-group label { display: flex; align-items: center; gap: 8px; color: var(--text-main); font-weight: 700; font-size: 1.1rem; margin-bottom: 8px; }
        .setting-group label i { color: var(--secondary-dark); width: 20px; text-align: center; }
        .remain-hint { font-size: 0.85rem; color: var(--text-sub); margin-top: 5px; font-weight: 500; margin-left: 30px; }

        input[type="number"] { width: 100%; border: 2px solid #dfe4ea; border-radius: 12px; padding: 12px; font-size: 1.4rem; font-weight: 700; text-align: center; color: #2f3542; background: #f1f2f6; transition: border-color 0.2s; }
        input[type="number"]:focus { border-color: var(--secondary-dark); outline: none; background: #fff; }

        .btn {
            background: var(--accent-color); color: #fff; border: none; border-radius: 50px; 
            padding: 16px 30px; font-size: 1.4rem; font-weight: 700; cursor: pointer; width: 100%; margin-top: 20px;
            box-shadow: 0 4px 15px rgba(255, 107, 107, 0.4); transition: all 0.2s;
            display: flex; align-items: center; justify-content: center; gap: 10px;
        }
        .btn:active { transform: scale(0.98); box-shadow: 0 2px 5px rgba(255, 107, 107, 0.2); }
        .btn:disabled { background: #ced6e0; box-shadow: none; cursor: not-allowed; }

        .btn-blue { background: var(--secondary-dark); box-shadow: 0 4px 15px rgba(10, 189, 227, 0.4); }
        .btn-blue:active { box-shadow: 0 2px 5px rgba(10, 189, 227, 0.2); }

        .btn-quit {
            background: transparent; color: #a4b0be; border: none; box-shadow: none;
            font-size: 0.9rem; padding: 15px; margin-top: 10px; text-decoration: none; width: auto;
            cursor: pointer; transition: color 0.3s; display: inline-flex; align-items: center; gap: 5px;
        }
        .btn-quit:hover { color: var(--danger); text-decoration: underline; }

        #game-screen { display: none; }
        .status-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; font-size: 1rem; font-weight: 700; color: #57606f; background: #f1f2f6; padding: 10px 20px; border-radius: 50px; }
        .status-bar i { margin-right: 5px; }

        #question-display {
            font-size: 4rem; font-weight: 900; min-height: 220px;
            display: flex; align-items: center; justify-content: center;
            color: #2f3542; background: #fff; border: 2px dashed #dfe4ea;
            border-radius: 20px; margin: 15px 0; padding: 10px; word-break: keep-all;
            flex-direction: column; 
        }

        .timer-container { 
            margin: 10px auto; 
            display: flex; flex-direction: column; align-items: center; 
            position: relative; /* æ°£æ³¡å®šä½åŸºæº– */
        }
        
        .timer-box { 
            font-size: 2.8rem; font-weight: 700; padding: 5px 30px; 
            color: var(--secondary-dark); 
            display: inline-flex; align-items: center; gap: 10px; 
            font-feature-settings: "tnum"; 
            transition: color 0.3s;
        }
        
        .timer-hint { font-size: 1rem; font-weight: 700; color: #aaa; margin-bottom: 5px; min-height: 1.2em; transition: color 0.3s;}

        .timer-prep .timer-box { color: var(--prep-color); }
        .timer-prep .timer-hint { color: var(--prep-color); }
        .timer-draw .timer-box { color: var(--draw-color); }
        .timer-draw .timer-hint { color: var(--draw-color); }

        .timer-warning { color: var(--danger) !important; animation: pulse 0.5s infinite alternate; }
        @keyframes pulse { from { opacity: 1; } to { opacity: 0.6; } }

        /* --- â˜… æ°£æ³¡ä½ç½®ä¿®æ­£ï¼šæ”¾åœ¨å³å´ (å…§éƒ¨) --- */
        .go-popup {
            position: absolute;
            top: 50%; /* å‚ç›´ç½®ä¸­ */
            left: 100%; /* æ”¾åœ¨è¨ˆæ™‚å™¨å³é‚Š */
            margin-left: 20px; /* è·é›¢è¨ˆæ™‚å™¨ 20px */
            transform: translateY(-50%) scale(0); /* åˆå§‹ç¸®å° */
            
            background: #ff6b6b; color: #fff; padding: 10px 20px; border-radius: 50px;
            font-size: 1.5rem; font-weight: 900; white-space: nowrap;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3); border: 3px solid #fff;
            opacity: 0; transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            pointer-events: none; z-index: 10;
        }
        
        /* å½ˆå‡ºå‹•ç•«ï¼šæ”¾å¤§ä¸¦æ—‹è½‰ */
        .go-popup.show { 
            transform: translateY(-50%) scale(1) rotate(10deg); 
            opacity: 1; 
        }

        .switch-container { display: inline-flex; align-items: center; justify-content: center; margin-top: 15px; font-size: 0.9rem; font-weight: 500; color: #a4b0be; cursor: pointer; gap: 8px; }
        .toggle-box { width: 40px; height: 22px; background: #dfe4ea; border-radius: 20px; position: relative; transition: background 0.3s; }
        .toggle-circle { width: 16px; height: 16px; background: #fff; border-radius: 50%; position: absolute; top: 3px; left: 3px; transition: transform 0.3s; box-shadow: 0 1px 3px rgba(0,0,0,0.2); }
        .switch-container.active .toggle-box { background: var(--switch-on-color); }
        .switch-container.active .toggle-circle { transform: translateX(18px); }

        .reload-link { margin-top: 25px; font-size: 0.9rem; color: #ccc; cursor:pointer; font-weight: 500; transition: color 0.3s; display: inline-flex; align-items: center; gap: 5px; }
        .reload-link:hover { color: var(--danger); }

        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); backdrop-filter: blur(2px); z-index: 2000; display: none; align-items: center; justify-content: center; padding: 20px; }
        .modal-box { background: #fff; border-radius: 24px; padding: 30px; width: 100%; max-width: 450px; max-height: 85vh; overflow-y: auto; box-shadow: 0 20px 50px rgba(0,0,0,0.3); }
        .modal-title { color: #2c3e50; text-align: center; font-size: 1.5rem; font-weight: 700; margin-bottom: 20px; border-bottom: 1px solid #eee; padding-bottom: 15px; display: flex; align-items: center; justify-content: center; gap: 10px;}
        .guide-section { margin-bottom: 18px; line-height: 1.6; font-size: 1rem; color: #555; text-align: left;}
        .guide-section strong { color: var(--accent-color); }

        /* --- æ‰‹æ©Ÿç‰ˆä¿®æ­£ï¼šæ°£æ³¡æ”¹åˆ°æ­£ä¸­å¤®ï¼Œé¿å…å·¦å³è¢«åˆ‡ --- */
        @media (max-width: 600px) {
            .variety-box { padding: 25px 20px; padding-top: 60px; }
            .top-btn-group { position: absolute; top: 15px; right: 15px; width: auto; }
            h1 { font-size: 1.8rem; margin-top: 0; }
            #question-display { min-height: 180px; font-size: 3rem; } 
            .btn { font-size: 1.3rem; padding: 14px; }
            
            /* æ°£æ³¡è¦†è“‹åœ¨è¨ˆæ™‚å™¨æ­£ä¸­å¤® */
            .go-popup {
                top: 50%;
                left: 50%;
                margin-left: 0;
                transform: translate(-50%, -50%) scale(0);
            }
            .go-popup.show {
                transform: translate(-50%, -50%) scale(1.2) rotate(-5deg); /* ç¨å¾®æ”¾å¤§ä¸€é» */
            }
        }
    </style>
</head>
<body>

    <audio id="bgm-player" loop><source src="bg-music.mp3" type="audio/mpeg"></audio>

    <div id="guide-modal" class="modal-overlay" onclick="closeGuide(event)">
        <div class="modal-box" onclick="event.stopPropagation()">
            <div class="modal-title"><i class="fas fa-book-open"></i> éŠæˆ²è¦å‰‡</div>
            <div class="guide-section"><strong><i class="fas fa-eye"></i> 1. æ§‹æ€èˆ‡ä½œç•«</strong><br>
                â€¢ <span style="color:#3498db">è—è‰²æ§‹æ€æœŸ</span>ï¼š10ç§’ / 5ç§’ (å‹¿å‹•ç­†)<br>
                â€¢ <span style="color:#2ecc71">ç¶ è‰²ä½œç•«æœŸ</span>ï¼šè½åˆ°å“¨éŸ³å¾Œé–‹å§‹ä½œç•«ï¼
            </div>
            <div class="guide-section"><strong><i class="fas fa-eye-slash"></i> 2. è¨˜æ†¶æŒ‘æˆ°</strong><br>
                ç¬¬ä¸€ä½ä½œç•«æ™‚ï¼Œ<strong>é¡Œç›®æœƒéš±è—</strong>ï¼Œå¿…é ˆåœ¨æ§‹æ€æœŸèƒŒä¸‹ä¾†ï¼<br>æ¥åŠ›æ™‚é¡Œç›®æœƒæ­£å¸¸é¡¯ç¤ºã€‚
            </div>
            <div class="guide-section"><strong><i class="fas fa-stopwatch"></i> 3. è‡ªå‹•æµç¨‹</strong><br>æŒ‰ä¸‹ã€Œä¸‹ä¸€é¡Œã€å¾Œï¼Œè‡ªå‹•é–‹å§‹ 10ç§’ å€’æ•¸ã€‚</div>
            <div class="guide-section"><strong><i class="fas fa-running"></i> 4. æ¥åŠ›ç©æ³•</strong><br>æ™‚é–“åˆ°å¾Œï¼ŒæŒ‰éˆ•æœƒé‡ç½®ã€‚ä¸‹ä¸€æ£’æŒ‰ä¸‹æŒ‰éˆ•ï¼Œæœƒå…ˆæœ‰ 5ç§’ çœ‹ç•«æ™‚é–“ï¼Œæ‰é–‹å§‹è¨ˆæ™‚ã€‚</div>
            <button class="btn" onclick="closeGuide(null)" style="margin-top:10px;">
                <i class="fas fa-check"></i> æˆ‘çŸ¥é“äº†
            </button>
        </div>
    </div>

    <div id="setup-screen" class="variety-box">
        <div class="top-btn-group">
            <button class="circle-btn" id="demo-btn" onclick="startDemo()" title="è©¦ç©æ¨¡å¼">
                <i class="fas fa-gamepad"></i>
            </button>
            <button class="circle-btn" onclick="openGuide()" title="è¦å‰‡èªªæ˜">
                <i class="fas fa-question"></i>
            </button>
        </div>

        <h1><i class="fas fa-palette"></i> ä½ ç•«æˆ‘çŒœ <span style="font-size:1.1rem; color:#888; font-weight:500; margin-top:8px;">æˆèªç‰ˆ</span></h1>
        
        <div class="setting-group">
            <label><i class="fas fa-cubes"></i> åŸºç¤é¡Œæ•¸ (å…·è±¡)</label>
            <input type="number" id="basic-count" value="3" min="0">
            <span id="basic-remain" class="remain-hint">è¼‰å…¥ä¸­...</span>
        </div>

        <div class="setting-group">
            <label><i class="fas fa-layer-group"></i> é€²éšé¡Œæ•¸ (æŠ½è±¡)</label>
            <input type="number" id="adv-count" value="2" min="0">
            <span id="adv-remain" class="remain-hint">è¼‰å…¥ä¸­...</span>
        </div>

        <div class="setting-group">
            <label><i class="fas fa-hourglass-half"></i> ä½œç•«æ™‚é–“ (ç§’)</label>
            <input type="number" id="timer-set" value="20" min="10" step="10">
        </div>

        <div class="switch-container active" onclick="toggleBGMSetup()" id="setup-bgm-switch">
            <div class="toggle-box"><div class="toggle-circle" style="transform: translateX(18px);"></div></div>
            <span><i class="fas fa-music"></i> èƒŒæ™¯éŸ³æ¨‚ (BGM)</span>
        </div>

        <button class="btn" onclick="startGame()">
            <i class="fas fa-play"></i> é–‹å§‹æŒ‘æˆ°
        </button>
        <div class="reload-link" onclick="resetHistory()"><i class="fas fa-trash-alt"></i> æ¸…é™¤å·²ç©ç´€éŒ„</div>
    </div>

    <div id="game-screen" class="variety-box">
        <div id="demo-ribbon" class="demo-ribbon">ğŸš§ è©¦ç©æ¨¡å¼</div>

        <div class="status-bar">
            <span id="level-tag" style="color:var(--secondary-dark);"><i class="fas fa-tag"></i> åŸºç¤é¡Œ</span>
            <span id="progress-text">1 / 5</span>
        </div>

        <div id="question-display">æº–å‚™ä¸­...</div>
        
        <div id="timer-wrapper" class="timer-container">
            <div id="go-popup" class="go-popup"><i class="fas fa-paint-brush"></i> GO!</div>
            <div id="timer-hint" class="timer-hint">æº–å‚™é–‹å§‹</div>
            <div class="timer-box" id="timer-display">--</div>
        </div>

        <button class="btn btn-blue" id="timer-btn" onclick="toggleTimer()">
            <i class="fas fa-stopwatch"></i> æš«åœ / é‡ç½®
        </button>
        
        <button class="btn" id="next-btn" onclick="nextQuestion()">
            ä¸‹ä¸€é¡Œ <i class="fas fa-chevron-right"></i>
        </button>
        
        <div style="margin-top: 15px;">
            <div class="switch-container active" onclick="toggleBGMGame()" id="game-bgm-switch">
                <div class="toggle-box"><div class="toggle-circle" style="transform: translateX(18px);"></div></div>
                <span><i class="fas fa-music"></i> BGM</span>
            </div>
        </div>

        <button class="btn-quit" onclick="confirmQuit()"><i class="fas fa-undo"></i> æ”¾æ£„æœ¬å±€ / å›åˆ°è¨­å®š</button>
    </div>

    <script>
        let gameQueue = [];
        let currentIndex = -1;
        let drawingDuration = 20; 
        let timerInterval = null;
        let isBGMOn = true; 
        let audioContext = null;
        let playedHistory = JSON.parse(localStorage.getItem('playedIdiomsHistory')) || [];
        let isDemoMode = false;
        let timerPhase = 'idle'; 
        let currentPrepDuration = 5;

        const setupScreen = document.getElementById('setup-screen');
        const gameScreen = document.getElementById('game-screen');
        const bgmPlayer = document.getElementById('bgm-player');
        const questionDisplay = document.getElementById('question-display');
        const progressText = document.getElementById('progress-text');
        const levelTag = document.getElementById('level-tag');
        const timerWrapper = document.getElementById('timer-wrapper');
        const timerDisplay = document.getElementById('timer-display');
        const timerHint = document.getElementById('timer-hint');
        const timerBtn = document.getElementById('timer-btn');
        const nextBtn = document.getElementById('next-btn');
        const guideModal = document.getElementById('guide-modal');
        const basicRemainLabel = document.getElementById('basic-remain');
        const advRemainLabel = document.getElementById('adv-remain');
        const demoRibbon = document.getElementById('demo-ribbon');
        const goPopup = document.getElementById('go-popup');

        if (typeof db_basic === 'undefined' || typeof db_advanced === 'undefined') {
            alert("âš ï¸ éŒ¯èª¤ï¼šæ‰¾ä¸åˆ°é¡Œåº«æª”æ¡ˆ questions.jsï¼");
        }

        function updateRemainCounts() {
            if (typeof db_basic === 'undefined') return;
            const availableBasic = db_basic.filter(q => !playedHistory.includes(q));
            const availableAdv = db_advanced.filter(q => !playedHistory.includes(q));
            basicRemainLabel.innerText = `(å°šæœ‰ ${availableBasic.length} é¡Œæœªç©é)`;
            advRemainLabel.innerText = `(å°šæœ‰ ${availableAdv.length} é¡Œæœªç©é)`;
        }
        updateRemainCounts();

        function openGuide() { guideModal.style.display = 'flex'; }
        function closeGuide(event) { if (event === null || event.target === guideModal) guideModal.style.display = 'none'; }

        function startDemo() {
            if(!confirm("ã€è©¦ç©æ¨¡å¼ã€‘\n\né¡Œç›®ä¸æœƒè¨ˆå…¥ç´€éŒ„ï¼Œä½œç•«æ™‚é–“å›ºå®š 8 ç§’ã€‚\næº–å‚™å¥½äº†å—ï¼Ÿ")) return;
            gameQueue = [
                {text: "ä¸€äº”ä¸€å", type: "åŸºç¤ç¯„ä¾‹", color: "var(--secondary-dark)"},
                {text: "ä¸ƒä¸Šå…«ä¸‹", type: "é€²éšç¯„ä¾‹", color: "var(--accent-color)"}
            ];
            drawingDuration = 8;
            isDemoMode = true;
            setupScreen.style.display = 'none';
            gameScreen.style.display = 'block';
            demoRibbon.style.display = 'block';
            if (!audioContext) audioContext = new (window.AudioContext || window.webkitAudioContext)();
            if (isBGMOn) bgmPlayer.play().catch(e => console.log("BGM blocked"));
            nextQuestion();
        }

        function startGame() {
            const basicCount = parseInt(document.getElementById('basic-count').value) || 0;
            const advCount = parseInt(document.getElementById('adv-count').value) || 0;
            drawingDuration = parseInt(document.getElementById('timer-set').value) || 20;

            if (basicCount + advCount === 0) { alert("è«‹è‡³å°‘è¨­å®šä¸€é¡Œï¼"); return; }

            const availableBasic = db_basic.filter(q => !playedHistory.includes(q));
            const availableAdv = db_advanced.filter(q => !playedHistory.includes(q));

            if (basicCount > availableBasic.length || advCount > availableAdv.length) {
                alert(`é¡Œåº«å­˜é‡ä¸è¶³ï¼\nè«‹æ¸›å°‘è¨­å®šæ•¸é‡ã€‚`);
                return;
            }

            const finalBasic = shuffleArray([...availableBasic]).slice(0, basicCount).map(t => ({text: t, type: 'åŸºç¤é¡Œ', color: 'var(--secondary-dark)'}));
            const finalAdv = shuffleArray([...availableAdv]).slice(0, advCount).map(t => ({text: t, type: 'é€²éšé¡Œ', color: 'var(--accent-color)'}));
            
            gameQueue = [...finalBasic, ...finalAdv];
            isDemoMode = false;

            if (!audioContext) audioContext = new (window.AudioContext || window.webkitAudioContext)();
            setupScreen.style.display = 'none';
            gameScreen.style.display = 'block';
            demoRibbon.style.display = 'none';
            
            if (isBGMOn) bgmPlayer.play().catch(e => console.log("BGM blocked"));

            nextQuestion();
        }

        function updateQuestionText(forceHide = false) {
            if (currentIndex < 0 || currentIndex >= gameQueue.length) return;
            const text = gameQueue[currentIndex].text;
            
            if (forceHide) {
                questionDisplay.innerHTML = '<span style="color:#ccc; font-size:2rem; line-height:1.5;">ğŸ™ˆ é¡Œç›®éš±è—ä¸­<br><span style="font-size:1.2rem">(è«‹æ†‘è¨˜æ†¶ä½œç•«)</span></span>';
                questionDisplay.style.border = "2px dashed #ccc";
            } else {
                questionDisplay.innerText = text;
                questionDisplay.style.border = "2px dashed #dfe4ea";
                const isMobile = window.innerWidth < 600;
                if (text.length > 5) {
                    questionDisplay.style.fontSize = isMobile ? "2.5rem" : "3.5rem";
                } else {
                    questionDisplay.style.fontSize = isMobile ? "3.5rem" : "5rem";
                }
            }
        }

        function nextQuestion() {
            stopTimer(true); 
            currentIndex++;

            if (currentIndex >= gameQueue.length) {
                let endText = isDemoMode ? "è©¦ç©çµæŸ" : "æŒ‘æˆ°çµæŸ";
                questionDisplay.innerHTML = `<span style='font-size: 2.5rem; color:var(--accent-color);'><i class='fas fa-flag-checkered'></i> ${endText}ï¼</span>`;
                progressText.innerText = "END"; 
                timerDisplay.innerHTML = "--";
                timerHint.innerText = "";
                timerWrapper.className = "timer-container"; 
                
                nextBtn.innerHTML = isDemoMode ? "<i class='fas fa-home'></i> å›è¨­å®šé " : "<i class='fas fa-redo'></i> æ–°çš„ä¸€å±€";
                nextBtn.onclick = () => location.reload();
                timerBtn.disabled = true;
                timerBtn.style.background = "#ccc";
                return;
            }

            const q = gameQueue[currentIndex];
            
            updateQuestionText(false);

            if (!isDemoMode) {
                playedHistory.push(q.text);
                localStorage.setItem('playedIdiomsHistory', JSON.stringify(playedHistory));
            }
            
            progressText.innerText = `${currentIndex + 1} / ${gameQueue.length}`;
            levelTag.innerHTML = `<i class="fas fa-tag"></i> ${q.type}`;
            levelTag.style.color = q.color;

            currentPrepDuration = 10;
            startPrepPhase(10);
        }

        function toggleTimer() {
            if (timerPhase === 'prep' || timerPhase === 'draw') {
                stopTimer();
                return;
            }
            currentPrepDuration = 5;
            startPrepPhase(5);
        }

        function startPrepPhase(seconds) {
            timerPhase = 'prep';
            updateQuestionText(false);

            timerWrapper.classList.remove('timer-draw');
            timerWrapper.classList.add('timer-prep');
            timerDisplay.classList.remove('timer-warning');
            
            let hintText = (seconds === 10) ? "æ–°é¡Œç›®ï¼šè«‹æ§‹æ€ (å‹¿å‹•ç­†)" : "æ¥åŠ›ï¼šè«‹çœ‹ç•« (å‹¿å‹•ç­†)";
            timerHint.innerHTML = `<i class="fas fa-brain"></i> ${hintText}`;
            
            timerBtn.innerHTML = '<i class="fas fa-pause"></i> åœæ­¢ / é‡ç½®';
            timerBtn.disabled = false;
            
            runTimer(seconds, () => {
                playWhistle();
                startDrawingPhase();
            });
        }

        function startDrawingPhase() {
            timerPhase = 'draw';
            
            if (currentPrepDuration === 10) {
                updateQuestionText(true); 
            } else {
                updateQuestionText(false); 
            }

            currentPrepDuration = 5; 

            let duration = drawingDuration;

            timerWrapper.classList.remove('timer-prep');
            timerWrapper.classList.add('timer-draw');
            
            timerHint.innerHTML = '<i class="fas fa-pencil-alt"></i> è«‹é–‹å§‹ä½œç•«ï¼';
            
            goPopup.classList.add('show');
            setTimeout(() => { goPopup.classList.remove('show'); }, 1500); 

            runTimer(duration, () => {
                playTimeUpSound();
                updateQuestionText(false);
                
                timerDisplay.innerHTML = '<i class="fas fa-times"></i> æ™‚é–“åˆ°';
                timerPhase = 'idle';
                
                timerBtn.innerHTML = '<i class="fas fa-redo"></i> æ¥åŠ› / é‡æ–°è¨ˆæ™‚';
                timerBtn.classList.add('btn-blue');
            });
        }

        function runTimer(seconds, onComplete) {
            clearInterval(timerInterval);
            let timeLeft = seconds;
            timerDisplay.innerHTML = timeLeft;

            timerInterval = setInterval(() => {
                timeLeft--;
                timerDisplay.innerHTML = timeLeft;

                if (timerPhase === 'draw' && timeLeft <= 5 && timeLeft > 0) {
                    timerDisplay.classList.add('timer-warning');
                    let pitch = 880 + (5 - timeLeft) * 50; 
                    playBeep(pitch, 0.15, 'square', 0.5); 
                }

                if (timeLeft < 0) {
                    clearInterval(timerInterval);
                    if (onComplete) onComplete();
                }
            }, 1000);
        }

        function stopTimer(fullReset = false) {
            clearInterval(timerInterval);
            timerInterval = null;
            timerDisplay.classList.remove('timer-warning');
            
            goPopup.classList.remove('show');
            updateQuestionText(false);

            if (fullReset) {
                timerPhase = 'idle';
                return;
            }

            timerPhase = 'idle';
            timerWrapper.classList.remove('timer-draw');
            timerWrapper.classList.add('timer-prep'); 
            
            let hintText = (currentPrepDuration === 10) ? "æº–å‚™é–‹å§‹ (æ–°é¡Œç›®)" : "æº–å‚™æ¥åŠ› (çœ‹ç•«)";
            timerHint.innerHTML = `<i class="fas fa-brain"></i> ${hintText}`;
            
            timerDisplay.innerHTML = currentPrepDuration; 
            
            timerBtn.innerHTML = '<i class="fas fa-play"></i> é–‹å§‹è¨ˆæ™‚';
            timerBtn.classList.add('btn-blue');
        }

        function playBeep(f, d, t='sine', v=1.0) {
            if (!audioContext) return;
            const o = audioContext.createOscillator();
            const g = audioContext.createGain();
            o.type = t; o.frequency.value = f;
            g.gain.setValueAtTime(v, audioContext.currentTime);
            g.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + d);
            o.connect(g); g.connect(audioContext.destination);
            o.start(); o.stop(audioContext.currentTime + d);
        }

        function playWhistle() {
            if (!audioContext) return;
            const o = audioContext.createOscillator();
            const g = audioContext.createGain();
            o.frequency.setValueAtTime(800, audioContext.currentTime);
            o.frequency.linearRampToValueAtTime(2000, audioContext.currentTime + 0.1); 
            g.gain.setValueAtTime(0.5, audioContext.currentTime);
            g.gain.linearRampToValueAtTime(0, audioContext.currentTime + 0.5);
            o.connect(g); g.connect(audioContext.destination);
            o.start(); o.stop(audioContext.currentTime + 0.5);
        }

        function playTimeUpSound() {
            if (!audioContext) return;
            const osc1 = audioContext.createOscillator();
            const osc2 = audioContext.createOscillator();
            const gainNode = audioContext.createGain();

            osc1.type = 'square'; osc2.type = 'square';
            osc1.frequency.value = 150; osc2.frequency.value = 155; 
            gainNode.gain.setValueAtTime(1.0, audioContext.currentTime);

            osc1.connect(gainNode); osc2.connect(gainNode);
            gainNode.connect(audioContext.destination);

            osc1.start(); osc2.start();
            osc1.stop(audioContext.currentTime + 0.4);
            osc2.stop(audioContext.currentTime + 0.2);
        }

        function toggleBGMSetup() { isBGMOn = !isBGMOn; updateSwitchUI('setup-bgm-switch', isBGMOn); updateSwitchUI('game-bgm-switch', isBGMOn); }
        function toggleBGMGame() { isBGMOn = !isBGMOn; updateSwitchUI('setup-bgm-switch', isBGMOn); updateSwitchUI('game-bgm-switch', isBGMOn); if (isBGMOn) bgmPlayer.play(); else bgmPlayer.pause(); }
        
        function updateSwitchUI(id, isOn) { 
            const container = document.getElementById(id);
            if (isOn) container.classList.add('active'); 
            else container.classList.remove('active');
        }
        function shuffleArray(array) { for (let i = array.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [array[i], array[j]] = [array[j], array[i]]; } return array; }

        function resetHistory() {
            if (confirm("ã€ç¢ºèªã€‘\nç¢ºå®šè¦æ¸…é™¤ç´€éŒ„å—ï¼Ÿ\næ¸…é™¤å¾Œï¼Œæˆèªå°‡æœƒé‡æ–°é‡è¤‡å‡ºç¾ã€‚")) {
                localStorage.removeItem('playedIdiomsHistory');
                alert("ç´€éŒ„å·²æ¸…é™¤ï¼");
                location.reload();
            }
        }

        function confirmQuit() {
            if (confirm("éŠæˆ²æ­£åœ¨é€²è¡Œä¸­ï¼Œç¢ºå®šè¦æ”¾æ£„ä¸¦å›åˆ°è¨­å®šé å—ï¼Ÿ")) {
                location.reload();
            }
        }
    </script>
</body>
</html>