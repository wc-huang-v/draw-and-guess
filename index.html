<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ä½ ç•«æˆ‘çŒœæˆèªç‰ˆ</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@500;700;900&display=swap" rel="stylesheet">
    
    <script src="questions.js"></script>

    <style>
        :root {
            /* --- é…è‰²é‡æ§‹ï¼šç¾ä»£å’Œè«§é¢¨æ ¼ --- */
            /* èƒŒæ™¯ï¼šæ·±é‚ƒçš„é›è—æ¼¸å±¤ï¼Œæ›´æœ‰è³ªæ„Ÿï¼Œä¸åˆºçœ¼ */
            --main-bg: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            
            /* å¡ç‰‡ï¼šä¹¾æ·¨çš„ç™½è‰²ï¼Œæ­é…æŸ”å’Œé™°å½± */
            --box-bg: #ffffff;
            --box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            
            /* æ–‡å­—ï¼šæ·±ç°èˆ‡èˆ‡æ·±è—ï¼Œé–±è®€èˆ’é© */
            --text-main: #333333;
            --text-sub: #666666;
            
            /* é‡é»è‰²ï¼šçŠç‘šç´… (ç”¨æ–¼ä¸»è¦æŒ‰éˆ•/å¼·èª¿) */
            --accent-color: #ff6b6b;
            --accent-hover: #ee5253;
            
            /* è¼”åŠ©è‰²ï¼šå¤©è— (ç”¨æ–¼è¨ˆæ™‚å™¨/æ¨™é¡Œ) */
            --secondary-color: #48dbfb;
            --secondary-dark: #0abde3;
            
            /* è­¦å‘Šè‰² */
            --danger: #ff4757;
        }

        * { box-sizing: border-box; user-select: none; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: 'Noto Sans TC', sans-serif;
            background: var(--main-bg);
            color: var(--text-main);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            min-height: 100vh; margin: 0; padding: 15px; overflow-x: hidden;
        }

        /* ä¸»è¦–çª—å¡ç‰‡è¨­è¨ˆ */
        .variety-box {
            background: var(--box-bg); 
            border-radius: 24px;
            box-shadow: var(--box-shadow);
            padding: 30px 25px; 
            position: relative; /* è®“å…§éƒ¨çš„çµ•å°å®šä½å…ƒç´ ä»¥é€™è£¡ç‚ºåŸºæº– */
            margin-bottom: 20px;
            width: 100%; max-width: 600px;
            text-align: center; 
            border: 1px solid rgba(255,255,255,0.1);
        }

        h1 {
            color: #2c3e50; 
            font-weight: 900; 
            font-size: 2.2rem; 
            margin: 10px 0 25px 0;
            letter-spacing: 1px;
        }

        /* --- è¦å‰‡èªªæ˜æŒ‰éˆ• (æ•´åˆé€²å¡ç‰‡å³ä¸Šè§’) --- */
        #guide-btn-integrated {
            position: absolute;
            top: 20px;
            right: 20px;
            background: #f1f2f6;
            color: #747d8c;
            border: none;
            border-radius: 50%;
            width: 36px;
            height: 36px;
            font-size: 1.2rem;
            cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            transition: all 0.2s;
        }
        #guide-btn-integrated:hover {
            background: var(--secondary-color);
            color: #fff;
            transform: scale(1.1);
        }

        /* è¨­å®šç¾¤çµ„ */
        .setting-group { margin-bottom: 20px; text-align: left; padding: 0 10px; }
        .setting-group label {
            display: block;
            color: #2c3e50;
            font-weight: 700;
            font-size: 1.1rem;
            margin-bottom: 8px;
        }
        
        .remain-hint { font-size: 0.85rem; color: var(--text-sub); margin-top: 5px; font-weight: 500; }

        input[type="number"] { 
            width: 100%; 
            border: 2px solid #dfe4ea; 
            border-radius: 12px; 
            padding: 12px; 
            font-size: 1.4rem; 
            font-weight: 700; 
            text-align: center; 
            color: #2f3542;
            background: #f1f2f6;
            transition: border-color 0.2s;
        }
        input[type="number"]:focus {
            border-color: var(--secondary-dark);
            outline: none;
            background: #fff;
        }

        /* é€šç”¨æŒ‰éˆ•æ¨£å¼ (æ‰å¹³åŒ–ç¾ä»£é¢¨) */
        .btn {
            background: var(--accent-color);
            color: #fff; 
            border: none; border-radius: 50px; 
            padding: 16px 30px; 
            font-size: 1.4rem; font-weight: 700; 
            cursor: pointer; width: 100%; margin-top: 20px;
            box-shadow: 0 4px 15px rgba(255, 107, 107, 0.4); 
            transition: all 0.2s;
        }
        .btn:active { transform: scale(0.98); box-shadow: 0 2px 5px rgba(255, 107, 107, 0.2); }
        .btn:disabled { background: #ced6e0; box-shadow: none; cursor: not-allowed; }

        /* è¨ˆæ™‚æŒ‰éˆ• (è—è‰²ç³») */
        .btn-blue {
            background: var(--secondary-dark);
            box-shadow: 0 4px 15px rgba(10, 189, 227, 0.4);
        }
        .btn-blue:active { box-shadow: 0 2px 5px rgba(10, 189, 227, 0.2); }

        /* éš±è—å¼æ”¾æ£„æŒ‰éˆ• */
        .btn-quit {
            background: transparent;
            color: #a4b0be;
            border: none; box-shadow: none;
            font-size: 0.9rem;
            padding: 15px; margin-top: 10px;
            text-decoration: none; width: auto;
            cursor: pointer; transition: color 0.3s;
        }
        .btn-quit:hover { color: var(--danger); text-decoration: underline; }

        #game-screen { display: none; }

        .status-bar {
            display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; 
            font-size: 1rem; font-weight: 700; color: #57606f; 
            background: #f1f2f6; padding: 10px 20px; border-radius: 50px;
        }

        /* é¡Œç›®é¡¯ç¤ºå€ */
        #question-display {
            font-size: 4rem; font-weight: 900; min-height: 220px;
            display: flex; align-items: center; justify-content: center;
            color: #2f3542; 
            background: #fff;
            /* è™›ç·šé‚Šæ¡†æ”¹ç‚ºæŸ”å’Œçš„å¯¦ç·šæˆ–å…§é™°å½± */
            border: 2px dashed #dfe4ea;
            border-radius: 20px; margin: 15px 0; padding: 10px;
            word-break: keep-all;
        }

        .timer-box { 
            font-size: 2.5rem; font-weight: 700; margin: 10px auto; padding: 5px 30px; 
            color: var(--secondary-dark); 
            display: inline-block; 
            font-feature-settings: "tnum"; /* è®“æ•¸å­—ç­‰å¯¬ï¼Œå€’æ•¸æ™‚ä¸æœƒè·³å‹• */
        }
        .timer-warning { color: var(--danger); animation: pulse 0.5s infinite alternate; }
        @keyframes pulse { from { opacity: 1; } to { opacity: 0.6; } }

        /* BGM é–‹é—œ */
        .switch-container { display: inline-flex; align-items: center; justify-content: center; margin-top: 15px; font-size: 0.9rem; font-weight: 500; color: #a4b0be; cursor: pointer; }
        .toggle-box { width: 40px; height: 22px; background: #dfe4ea; border-radius: 20px; margin-right: 10px; position: relative; transition: background 0.3s; }
        .toggle-circle { width: 16px; height: 16px; background: #fff; border-radius: 50%; position: absolute; top: 3px; left: 3px; transition: transform 0.3s; box-shadow: 0 1px 3px rgba(0,0,0,0.2); }
        .active .toggle-box { background: var(--secondary-dark); }
        .active .toggle-circle { transform: translateX(18px); }

        .reload-link { margin-top: 25px; font-size: 0.9rem; color: #ccc; cursor:pointer; font-weight: 500; transition: color 0.3s; }
        .reload-link:hover { color: var(--danger); }

        /* å½ˆçª—æ¨£å¼ */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); backdrop-filter: blur(2px); z-index: 2000; display: none; align-items: center; justify-content: center; padding: 20px; }
        .modal-box { background: #fff; border-radius: 24px; padding: 30px; width: 100%; max-width: 450px; max-height: 85vh; overflow-y: auto; box-shadow: 0 20px 50px rgba(0,0,0,0.3); }
        .modal-title { color: #2c3e50; text-align: center; font-size: 1.5rem; font-weight: 700; margin-bottom: 20px; border-bottom: 1px solid #eee; padding-bottom: 15px; }
        .guide-section { margin-bottom: 18px; line-height: 1.6; font-size: 1rem; color: #555; text-align: left;}
        .guide-section strong { color: var(--accent-color); }

        @media (max-width: 600px) {
            .variety-box { padding: 25px 20px; }
            h1 { font-size: 1.8rem; }
            #question-display { min-height: 180px; font-size: 3rem; } 
            .btn { font-size: 1.3rem; padding: 14px; }
        }
    </style>
</head>
<body>

    <audio id="bgm-player" loop><source src="bg-music.mp3" type="audio/mpeg"></audio>

    <div id="guide-modal" class="modal-overlay" onclick="closeGuide(event)">
        <div class="modal-box" onclick="event.stopPropagation()">
            <div class="modal-title">ğŸ¨ éŠæˆ²è¦å‰‡</div>
            <div class="guide-section"><strong>1. åŸºç¤èˆ‡é€²éš</strong><br>ã€ŒåŸºç¤é¡Œã€å¤šç‚ºå…·è±¡å¥½ç•«çš„æˆèªï¼›ã€Œé€²éšé¡Œã€å‰‡ç‚ºæŠ½è±¡æˆ–è¤‡é›œçš„æŒ‘æˆ°ã€‚</div>
            <div class="guide-section"><strong>2. æ™ºæ…§ä¸é‡è¤‡</strong><br>ç³»çµ±æœƒè¨˜ä½é€™å°è£ç½®ç©éçš„é¡Œç›®ï¼Œç›´åˆ°é¡Œåº«ç”¨ç›¡ã€‚</div>
            <div class="guide-section"><strong>3. æ“ä½œå¯†æŠ€</strong><br>æ™‚é–“è¨­å®šå¯æŒ‰ä¸Šä¸‹éµå¢æ¸› 10 ç§’ã€‚éŠæˆ²ä¸­å¯æŒ‰ã€Œæ”¾æ£„ã€å›åˆ°é¦–é ã€‚</div>
            <div class="guide-section"><strong>4. é‡ç½®ç´€éŒ„</strong><br>è‹¥æƒ³é‡æ–°éŠç©æ‰€æœ‰é¡Œç›®ï¼Œè«‹é»æ“Šè¨­å®šé ä¸‹æ–¹çš„ã€Œæ¸…é™¤ç´€éŒ„ã€ã€‚</div>
            <button class="btn" onclick="closeGuide(null)" style="margin-top:10px;">æˆ‘çŸ¥é“äº†</button>
        </div>
    </div>

    <div id="setup-screen" class="variety-box">
        <button id="guide-btn-integrated" onclick="openGuide()" title="è¦å‰‡èªªæ˜">?</button>

        <h1>ä½ ç•«æˆ‘çŒœ <span style="font-size:1rem; color:#888; font-weight:500;">æˆèªç‰ˆ</span></h1>
        
        <div class="setting-group">
            <label>åŸºç¤é¡Œæ•¸ (å…·è±¡)</label>
            <input type="number" id="basic-count" value="3" min="0">
            <span id="basic-remain" class="remain-hint">è¼‰å…¥ä¸­...</span>
        </div>

        <div class="setting-group">
            <label>é€²éšé¡Œæ•¸ (æŠ½è±¡)</label>
            <input type="number" id="adv-count" value="2" min="0">
            <span id="adv-remain" class="remain-hint">è¼‰å…¥ä¸­...</span>
        </div>

        <div class="setting-group">
            <label>å€’æ•¸æ™‚é–“ (ç§’)</label>
            <input type="number" id="timer-set" value="20" min="10" step="10">
        </div>

        <div class="switch-container" onclick="toggleBGMSetup()" id="setup-bgm-switch">
            <div class="toggle-box"><div class="toggle-circle"></div></div>
            <span>èƒŒæ™¯éŸ³æ¨‚ (BGM)</span>
        </div>

        <button class="btn" onclick="startGame()">é–‹å§‹æŒ‘æˆ°</button>
        
        <div class="reload-link" onclick="resetHistory()">
            æ¸…é™¤å·²ç©ç´€éŒ„ (é‡ç½®é¡Œåº«)
        </div>
    </div>

    <div id="game-screen" class="variety-box">
        <div class="status-bar">
            <span id="level-tag" style="color:var(--secondary-dark);">â— åŸºç¤é¡Œ</span>
            <span id="progress-text">1 / 5</span>
        </div>

        <div id="question-display">æº–å‚™ä¸­...</div>
        <div class="timer-box" id="timer-display">--</div>

        <button class="btn btn-blue" id="timer-btn" onclick="toggleTimer()">é–‹å§‹è¨ˆæ™‚</button>
        <button class="btn" id="next-btn" onclick="nextQuestion()">ä¸‹ä¸€é¡Œ</button>
        
        <div style="margin-top: 15px;">
            <div class="switch-container" onclick="toggleBGMGame()" id="game-bgm-switch">
                <div class="toggle-box"><div class="toggle-circle"></div></div>
                <span>BGM</span>
            </div>
        </div>

        <button class="btn-quit" onclick="confirmQuit()">æ”¾æ£„æœ¬å±€ / å›åˆ°è¨­å®š</button>
    </div>

    <script>
        // --- éŠæˆ²ç‹€æ…‹ ---
        let gameQueue = [];
        let currentIndex = -1;
        let timerDuration = 60;
        let timerInterval = null;
        let isBGMOn = false; // é è¨­é—œé–‰ BGMï¼Œæ¯”è¼ƒä¸æ“¾äººï¼Œä½¿ç”¨è€…æƒ³é–‹å†é–‹
        let audioContext = null;
        let playedHistory = JSON.parse(localStorage.getItem('playedIdiomsHistory')) || [];

        // --- DOM ---
        const setupScreen = document.getElementById('setup-screen');
        const gameScreen = document.getElementById('game-screen');
        const bgmPlayer = document.getElementById('bgm-player');
        const questionDisplay = document.getElementById('question-display');
        const progressText = document.getElementById('progress-text');
        const levelTag = document.getElementById('level-tag');
        const timerDisplay = document.getElementById('timer-display');
        const timerBtn = document.getElementById('timer-btn');
        const nextBtn = document.getElementById('next-btn');
        const guideModal = document.getElementById('guide-modal');
        const basicRemainLabel = document.getElementById('basic-remain');
        const advRemainLabel = document.getElementById('adv-remain');

        // --- æª¢æŸ¥é¡Œåº« ---
        if (typeof db_basic === 'undefined' || typeof db_advanced === 'undefined') {
            alert("âš ï¸ éŒ¯èª¤ï¼šæ‰¾ä¸åˆ°é¡Œåº«æª”æ¡ˆ questions.jsï¼\nè«‹ç¢ºèª index.html èˆ‡ questions.js æ”¾åœ¨åŒä¸€å€‹è³‡æ–™å¤¾å…§ã€‚");
        }

        function updateRemainCounts() {
            if (typeof db_basic === 'undefined') return;
            const availableBasic = db_basic.filter(q => !playedHistory.includes(q));
            const availableAdv = db_advanced.filter(q => !playedHistory.includes(q));
            basicRemainLabel.innerText = `(å°šæœ‰ ${availableBasic.length} é¡Œæœªç©é)`;
            advRemainLabel.innerText = `(å°šæœ‰ ${availableAdv.length} é¡Œæœªç©é)`;
        }
        updateRemainCounts();

        function openGuide() { guideModal.style.display = 'flex'; }
        function closeGuide(event) { if (event === null || event.target === guideModal) guideModal.style.display = 'none'; }

        // --- 1. é–‹å§‹éŠæˆ² ---
        function startGame() {
            const basicCount = parseInt(document.getElementById('basic-count').value) || 0;
            const advCount = parseInt(document.getElementById('adv-count').value) || 0;
            timerDuration = parseInt(document.getElementById('timer-set').value) || 20;

            if (basicCount + advCount === 0) { alert("è«‹è‡³å°‘è¨­å®šä¸€é¡Œï¼"); return; }

            const availableBasic = db_basic.filter(q => !playedHistory.includes(q));
            const availableAdv = db_advanced.filter(q => !playedHistory.includes(q));

            if (basicCount > availableBasic.length || advCount > availableAdv.length) {
                alert(`é¡Œåº«å­˜é‡ä¸è¶³ï¼\n\nåŸºç¤é¡Œå‰©: ${availableBasic.length}\né€²éšé¡Œå‰©: ${availableAdv.length}\n\nè«‹æ¸›å°‘è¨­å®šæ•¸é‡ã€‚`);
                return;
            }

            const finalBasic = shuffleArray([...availableBasic]).slice(0, basicCount).map(t => ({text: t, type: 'åŸºç¤é¡Œ', color: 'var(--secondary-dark)'}));
            const finalAdv = shuffleArray([...availableAdv]).slice(0, advCount).map(t => ({text: t, type: 'é€²éšé¡Œ', color: 'var(--accent-color)'}));
            
            gameQueue = [...finalBasic, ...finalAdv];

            if (!audioContext) audioContext = new (window.AudioContext || window.webkitAudioContext)();
            setupScreen.style.display = 'none';
            gameScreen.style.display = 'block';
            if (isBGMOn) { bgmPlayer.volume = 0.5; bgmPlayer.play().catch(e => console.log("BGM Blocked")); }

            nextQuestion();
        }

        // --- 2. é¡Œç›®æ§åˆ¶ ---
        function nextQuestion() {
            stopTimer();
            timerDisplay.innerText = timerDuration;
            timerDisplay.classList.remove('timer-warning');
            timerBtn.innerText = "é–‹å§‹è¨ˆæ™‚";
            timerBtn.disabled = false;
            timerBtn.classList.add('btn-blue'); // æ¢å¾©è—è‰²

            currentIndex++;

            if (currentIndex >= gameQueue.length) {
                questionDisplay.innerHTML = "<span style='font-size: 2.5rem; color:var(--accent-color);'>ğŸ‰ æŒ‘æˆ°çµæŸï¼</span>";
                progressText.innerText = "END"; levelTag.innerText = "";
                nextBtn.innerText = "æ–°çš„ä¸€å±€";
                nextBtn.onclick = () => location.reload();
                timerBtn.disabled = true;
                timerBtn.classList.remove('btn-blue');
                timerBtn.style.background = "#ccc";
                return;
            }

            const q = gameQueue[currentIndex];
            questionDisplay.innerText = q.text;

            playedHistory.push(q.text);
            localStorage.setItem('playedIdiomsHistory', JSON.stringify(playedHistory));
            
            const isMobile = window.innerWidth < 600;
            if (q.text.length > 5) {
                questionDisplay.style.fontSize = isMobile ? "2.5rem" : "3.5rem";
            } else {
                questionDisplay.style.fontSize = isMobile ? "3.5rem" : "5rem";
            }

            progressText.innerText = `${currentIndex + 1} / ${gameQueue.length}`;
            levelTag.innerText = `â— ${q.type}`;
            levelTag.style.color = q.color;
        }

        // --- 3. è¨ˆæ™‚å™¨èˆ‡éŸ³æ•ˆ ---
        function toggleTimer() {
            if (timerInterval) { stopTimer(); return; }
            let timeLeft = timerDuration;
            timerDisplay.innerText = timeLeft;
            timerBtn.innerText = "åœæ­¢";
            timerBtn.classList.remove('btn-blue'); // è®Šè‰²ä»¥ç¤ºå€åˆ¥
            timerBtn.style.background = "#57606f";
            
            timerInterval = setInterval(() => {
                timeLeft--;
                timerDisplay.innerText = timeLeft;

                if (timeLeft <= 5 && timeLeft > 0) {
                    timerDisplay.classList.add('timer-warning');
                    let pitch = 880 + (5 - timeLeft) * 50; 
                    playBeep(pitch, 0.15, 'square', 0.5); 
                } else if (timeLeft === 0) {
                    playBeep(200, 1.5, 'sawtooth', 1.0); 
                    timerDisplay.innerText = "æ™‚é–“åˆ°";
                    stopTimer();
                    timerBtn.innerText = "é–‹å§‹è¨ˆæ™‚";
                    timerBtn.disabled = true;
                    timerBtn.style.background = "#ccc";
                }
            }, 1000);
        }

        function stopTimer() { 
            clearInterval(timerInterval); 
            timerInterval = null; 
            timerDisplay.classList.remove('timer-warning'); 
            if(!timerBtn.disabled) {
                timerBtn.innerText = "é–‹å§‹è¨ˆæ™‚";
                timerBtn.classList.add('btn-blue');
                timerBtn.style.background = ""; // æ¸…é™¤ inline style
            }
        }

        function playBeep(frequency, duration, type = 'sine', volume = 1.0) {
            if (!audioContext) return;
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            oscillator.type = type;
            oscillator.frequency.value = frequency;
            gainNode.gain.setValueAtTime(volume, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + duration);
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            oscillator.start();
            oscillator.stop(audioContext.currentTime + duration);
        }

        function toggleBGMSetup() { isBGMOn = !isBGMOn; updateSwitchUI('setup-bgm-switch', isBGMOn); updateSwitchUI('game-bgm-switch', isBGMOn); }
        function toggleBGMGame() { isBGMOn = !isBGMOn; updateSwitchUI('setup-bgm-switch', isBGMOn); updateSwitchUI('game-bgm-switch', isBGMOn); if (isBGMOn) bgmPlayer.play(); else bgmPlayer.pause(); }
        function updateSwitchUI(id, isOn) { 
            const box = document.getElementById(id);
            if (isOn) box.classList.add('active'); else box.classList.remove('active'); 
        }
        function shuffleArray(array) { for (let i = array.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [array[i], array[j]] = [array[j], array[i]]; } return array; }

        function resetHistory() {
            if (confirm("ã€ç¢ºèªã€‘\nç¢ºå®šè¦æ¸…é™¤ç´€éŒ„å—ï¼Ÿ\næ¸…é™¤å¾Œï¼Œæˆèªå°‡æœƒé‡æ–°é‡è¤‡å‡ºç¾ã€‚")) {
                localStorage.removeItem('playedIdiomsHistory');
                alert("ç´€éŒ„å·²æ¸…é™¤ï¼");
                location.reload();
            }
        }

        function confirmQuit() {
            if (confirm("éŠæˆ²æ­£åœ¨é€²è¡Œä¸­ï¼Œç¢ºå®šè¦æ”¾æ£„ä¸¦å›åˆ°è¨­å®šé å—ï¼Ÿ")) {
                location.reload();
            }
        }
    </script>
</body>
</html>